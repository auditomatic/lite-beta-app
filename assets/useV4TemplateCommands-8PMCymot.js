import{g as j,d as o,a as p,r as T,c as F}from"./index-Be9cnb4G.js";import{b as k}from"./useV4VariableLists-BT4miRvE.js";class R{async create(t){try{const e=j("template"),r=await this.validateTemplate(t.template,t.variables);if(!r.isValid)return{ok:!1,error:new Error(`Template validation failed: ${r.errors.join(", ")}`)};if(t.variables){const n=await this.validateVariableListReferences(t.variables);if(!n.valid)return{ok:!1,error:new Error(`Invalid variable list references: ${n.errors.join(", ")}`)}}const a=new Date,i={id:e,name:t.name,description:t.description,type:"template",template:t.template,variables:t.variables?Object.freeze(this.deepFreezeVariables(t.variables)):Object.freeze({}),category:t.category||"Custom",tags:t.tags?Object.freeze([...t.tags]):Object.freeze([]),isDefault:!1,created:a,updated:a,outputType:t.outputType,extractPattern:t.extractPattern,refusalWords:t.refusalWords?Object.freeze([...t.refusalWords]):void 0,rejectRefusalWords:t.rejectRefusalWords},s=Object.freeze(i);return await o.transaction("rw",o.template_prompts,async()=>{await o.template_prompts.add(s)}),p.info("V4: Created template",{id:e,name:t.name,variableCount:Object.keys(t.variables||{}).length}),k("templates","create"),{ok:!0,value:e}}catch(e){return p.error("V4: Failed to create template",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to create template")}}}async update(t,e){try{const r=await o.template_prompts.get(t);if(!r)return{ok:!1,error:new Error("Template not found")};if(e.template!==void 0){const i=await this.validateTemplate(e.template,e.variables||r.variables);if(!i.isValid)return{ok:!1,error:new Error(`Template validation failed: ${i.errors.join(", ")}`)}}if(e.variables!==void 0){const i=await this.validateVariableListReferences(e.variables);if(!i.valid)return{ok:!1,error:new Error(`Invalid variable list references: ${i.errors.join(", ")}`)}}const a={...e,updated:new Date};return this.freezeUpdateData(a),await o.transaction("rw",o.template_prompts,async()=>{await o.template_prompts.update(t,a)}),p.info("V4: Updated template",{id:t,updates:Object.keys(e)}),k("templates","update"),{ok:!0,value:void 0}}catch(r){return p.error("V4: Failed to update template",r),{ok:!1,error:r instanceof Error?r:new Error("Failed to update template")}}}async delete(t){try{const e=await o.template_prompts.get(t);return e?(await o.transaction("rw",o.template_prompts,async()=>{await o.template_prompts.delete(t)}),p.info("V4: Deleted template",{id:t,name:e.name}),k("templates","delete"),{ok:!0,value:void 0}):{ok:!1,error:new Error("Template not found")}}catch(e){return p.error("V4: Failed to delete template",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to delete template")}}}async duplicate(t,e){try{const r=await o.template_prompts.get(t);if(!r)return{ok:!1,error:new Error("Template not found")};const a={name:e||`${r.name} (Copy)`,description:r.description,template:r.template,variables:r.variables?this.deepCloneVariables(r.variables):void 0,category:r.category,tags:r.tags?[...r.tags]:void 0,outputType:r.outputType,extractPattern:r.extractPattern,refusalWords:r.refusalWords?[...r.refusalWords]:void 0,rejectRefusalWords:r.rejectRefusalWords};return await this.create(a)}catch(r){return p.error("V4: Failed to duplicate template",r),{ok:!1,error:r instanceof Error?r:new Error("Failed to duplicate template")}}}async linkVariableList(t,e,r){try{const a=await o.template_prompts.get(t);if(!a)return{ok:!1,error:new Error("Template not found")};if(!await o.variableLists.get(r))return{ok:!1,error:new Error("Variable list not found")};const s={...a.variables,[e]:Object.freeze({type:"list",listId:r})};return await o.transaction("rw",o.template_prompts,async()=>{await o.template_prompts.update(t,{variables:Object.freeze(s),updated:new Date})}),p.info("V4: Linked variable list to template",{templateId:t,variableName:e,listId:r}),{ok:!0,value:void 0}}catch(a){return p.error("V4: Failed to link variable list",a),{ok:!1,error:a instanceof Error?a:new Error("Failed to link variable list")}}}async unlinkVariableList(t,e){try{const r=await o.template_prompts.get(t);if(!r)return{ok:!1,error:new Error("Template not found")};const{[e]:a,...i}=r.variables||{};return await o.transaction("rw",o.template_prompts,async()=>{await o.template_prompts.update(t,{variables:Object.freeze(i),updated:new Date})}),p.info("V4: Unlinked variable from template",{templateId:t,variableName:e}),{ok:!0,value:void 0}}catch(r){return p.error("V4: Failed to unlink variable list",r),{ok:!1,error:r instanceof Error?r:new Error("Failed to unlink variable list")}}}async updateVariableListReferences(t,e){try{const r=await o.template_prompts.toArray(),a=[],i=[];for(const n of r){if(!n.variables)continue;let l=!1;const u={...n.variables};for(const[f,d]of Object.entries(n.variables))d.type==="list"&&d.listId===t&&(u[f]=Object.freeze({...d,listId:e}),l=!0);l&&(a.push(n.id),i.push({id:n.id,variables:Object.freeze(u)}))}i.length>0&&await o.transaction("rw",o.template_prompts,async()=>{const n=new Date;for(const l of i)await o.template_prompts.update(l.id,{variables:l.variables,updated:n})});const s={updatedTemplates:i.length,affectedTemplateIds:a};return p.info("V4: Updated variable list references",{oldListId:t,newListId:e,affectedCount:i.length}),{ok:!0,value:s}}catch(r){return p.error("V4: Failed to update variable list references",r),{ok:!1,error:r instanceof Error?r:new Error("Failed to update variable list references")}}}async bulkCreate(t){try{const e=[],r=new Date;for(const i of t){const s=await this.validateTemplate(i.template,i.variables);if(!s.isValid)return{ok:!1,error:new Error(`Bulk validation failed for "${i.name}": ${s.errors.join(", ")}`)};if(i.variables){const n=await this.validateVariableListReferences(i.variables);if(!n.valid)return{ok:!1,error:new Error(`Invalid variable list references in "${i.name}": ${n.errors.join(", ")}`)}}}const a=t.map(i=>{const s=j("template"),n={id:s,name:i.name,description:i.description,type:"template",template:i.template,variables:i.variables?Object.freeze(this.deepFreezeVariables(i.variables)):Object.freeze({}),category:i.category||"Custom",tags:i.tags?Object.freeze([...i.tags]):Object.freeze([]),isDefault:!1,created:r,updated:r,outputType:i.outputType,extractPattern:i.extractPattern,refusalWords:i.refusalWords?Object.freeze([...i.refusalWords]):void 0,rejectRefusalWords:i.rejectRefusalWords};return e.push(s),Object.freeze(n)});return await o.transaction("rw",o.template_prompts,async()=>{await o.template_prompts.bulkAdd(a)}),p.info("V4: Bulk created templates",{count:t.length}),{ok:!0,value:e}}catch(e){return p.error("V4: Failed to bulk create templates",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to bulk create templates")}}}async bulkUpdate(t){try{const e=t.map(s=>s.id),r=await o.template_prompts.where("id").anyOf(e).toArray();if(r.length!==e.length){const s=new Set(r.map(l=>l.id)),n=e.filter(l=>!s.has(l));return{ok:!1,error:new Error(`Some templates not found: ${n.join(", ")}`)}}const a=new Date,i=t.map(({id:s,data:n})=>{const l={...n,updated:a};return this.freezeUpdateData(l),{key:s,changes:l}});return await o.transaction("rw",o.template_prompts,async()=>{await o.template_prompts.bulkUpdate(i)}),p.info("V4: Bulk updated templates",{count:t.length}),{ok:!0,value:void 0}}catch(e){return p.error("V4: Failed to bulk update templates",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to bulk update templates")}}}async bulkDelete(t){try{return await o.transaction("rw",o.template_prompts,async()=>{await o.template_prompts.bulkDelete(t)}),p.info("V4: Bulk deleted templates",{count:t.length}),{ok:!0,value:void 0}}catch(e){return p.error("V4: Failed to bulk delete templates",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to bulk delete templates")}}}async importTemplates(t){try{const e=JSON.parse(t),r=Array.isArray(e)?e:[e],a={imported:0,skipped:0,errors:[],invalidReferences:[]},i=[];for(const s of r)try{if(!s.name||!s.template){a.errors.push(`Template missing required fields: ${s.name||"unnamed"}`),a.skipped++;continue}const n=[];if(s.variables)for(const[,l]of Object.entries(s.variables))typeof l=="object"&&l!==null&&"type"in l&&l.type==="list"&&"listId"in l&&l.listId&&(await o.variableLists.get(l.listId)||n.push(l.listId));n.length>0&&a.invalidReferences.push({templateName:s.name,missingListIds:n}),i.push({name:s.name,description:s.description,template:s.template,variables:s.variables,category:s.category,tags:s.tags,outputType:s.outputType,extractPattern:s.extractPattern,refusalWords:s.refusalWords,rejectRefusalWords:s.rejectRefusalWords})}catch(n){a.errors.push(`Failed to process template ${s.name||"unnamed"}: ${n instanceof Error?n.message:"Unknown error"}`),a.skipped++}if(i.length>0){const s=await this.bulkCreate(i);s.ok?a.imported=s.value.length:a.errors.push(`Bulk import failed: ${s.error.message}`)}return{ok:!0,value:a}}catch(e){return p.error("V4: Failed to import templates",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to import templates")}}}async exportTemplates(t){try{const e=await o.template_prompts.where("id").anyOf(t).toArray();return{ok:!0,value:JSON.stringify(e,null,2)}}catch(e){return p.error("V4: Failed to export templates",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to export templates")}}}async validateTemplateIntegrity(t){try{const e=t?await o.template_prompts.where("id").equals(t).toArray():await o.template_prompts.toArray(),r={totalTemplates:e.length,templatesWithInvalidReferences:[],orphanedReferences:[]},a=await o.variableLists.toArray(),i=new Set(a.map(s=>s.id));for(const s of e){if(!s.variables)continue;const n=[];for(const[l,u]of Object.entries(s.variables))u.type==="list"&&u.listId?i.has(u.listId)||(n.push({variableName:l,listId:u.listId,issue:"missing_list"}),r.orphanedReferences.push({templateId:s.id,variableName:l,listId:u.listId})):u.type==="list"&&!u.listId&&n.push({variableName:l,listId:"unknown",issue:"invalid_binding"});n.length>0&&r.templatesWithInvalidReferences.push({templateId:s.id,templateName:s.name,invalidVariables:n})}return{ok:!0,value:r}}catch(e){return p.error("V4: Failed to validate template integrity",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to validate template integrity")}}}async cleanupInvalidReferences(){try{const t=await this.validateTemplateIntegrity();if(!t.ok)return{ok:!1,error:t.error};const e={removedReferences:0,affectedTemplates:[]},r=t.value;if(r.orphanedReferences.length>0){const a=[],i=new Map;for(const n of r.orphanedReferences)i.has(n.templateId)||i.set(n.templateId,[]),i.get(n.templateId).push(n.variableName);const s=await o.template_prompts.where("id").anyOf(Array.from(i.keys())).toArray();for(const n of s){const l=i.get(n.id)||[];if(l.length===0)continue;const u={...n.variables};let f=0;for(const d of l)u[d]&&(delete u[d],f++);f>0&&(a.push({id:n.id,variables:Object.freeze(u)}),e.removedReferences+=f,e.affectedTemplates.push(n.id))}a.length>0&&await o.transaction("rw",o.template_prompts,async()=>{const n=new Date;for(const l of a)await o.template_prompts.update(l.id,{variables:l.variables,updated:n})})}return p.info("V4: Cleaned up invalid template references",e),{ok:!0,value:e}}catch(t){return p.error("V4: Failed to cleanup invalid references",t),{ok:!1,error:t instanceof Error?t:new Error("Failed to cleanup invalid references")}}}async enrichWithVariableListData(t){try{const e=new Set;for(const s of t)if(s.variables)for(const n of Object.values(s.variables))n.type==="list"&&n.listId&&e.add(n.listId);const r=await o.variableLists.where("id").anyOf(Array.from(e)).toArray(),a=new Map(r.map(s=>[s.id,s]));return{ok:!0,value:t.map(s=>{const n=Object.keys(s.variables||{}).length;let l=1;const u={},f=[];if(s.variables)for(const[w,b]of Object.entries(s.variables))if(b.type==="list"&&b.listId){const v=a.get(b.listId);v?(u[w]=v,v.category==="simple"&&v.values?l*=v.values.length:v.category==="attributed"&&v.items?l*=v.items.length:v.category==="tabular"&&v.itemCount&&(l*=v.itemCount)):f.push(b.listId)}else b.type==="value"&&b.values&&(l*=b.values.length);const d={...s,variableCount:n,combinationCount:l,tokenEstimate:Math.ceil(s.template.length/4),variableListData:Object.keys(u).length>0?Object.freeze(u):void 0,missingVariableLists:f.length>0?Object.freeze(f):void 0};return Object.freeze(d)})}}catch(e){return p.error("V4: Failed to enrich templates with variable list data",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to enrich templates")}}}async validateTemplate(t,e){const r=[],a=[],i=/\{\{([^}]+)\}\}/g,s=new Set;let n;for(;(n=i.exec(t))!==null;)s.add(n[1].trim());t.trim()||r.push("Template cannot be empty");const l=(t.match(/\{\{/g)||[]).length,u=(t.match(/\}\}/g)||[]).length;l!==u&&r.push("Template has unclosed variable braces");const f=new Set(Object.keys(e||{})),d=Array.from(s).filter(b=>!f.has(b)),w=Array.from(f).filter(b=>!s.has(b));return d.length>0&&a.push(`Variables used in template but not defined: ${d.join(", ")}`),w.length>0&&a.push(`Variables defined but not used in template: ${w.join(", ")}`),{isValid:r.length===0,errors:r,warnings:a,extractedVariables:Array.from(s),missingVariables:d,unusedVariables:w}}async validateVariableListReferences(t){const e=[],r=Object.values(t).filter(a=>a.type==="list"&&a.listId).map(a=>a.listId);if(r.length>0){const a=await o.variableLists.where("id").anyOf(r).toArray(),i=new Set(a.map(n=>n.id)),s=r.filter(n=>!i.has(n));s.length>0&&e.push(`Referenced variable lists not found: ${s.join(", ")}`)}return{valid:e.length===0,errors:e}}deepFreezeVariables(t){const e={};for(const[r,a]of Object.entries(t))a.values?e[r]=Object.freeze({...a,values:Object.freeze([...a.values])}):e[r]=Object.freeze({...a});return e}deepCloneVariables(t){const e={};for(const[r,a]of Object.entries(t))a.values?e[r]={...a,values:[...a.values]}:e[r]={...a};return e}freezeUpdateData(t){t.variables&&(t.variables=Object.freeze(this.deepFreezeVariables(t.variables))),t.tags&&(t.tags=Object.freeze([...t.tags])),t.refusalWords&&(t.refusalWords=Object.freeze([...t.refusalWords]))}}const m=new R;function x(){const g=T(new Set),t=T(null),e=F(()=>g.value.size>0);function r(){t.value=null}async function a(c,y){g.value.add(c),t.value=null;try{const h=await y();return h.ok||(t.value=h.error),h}catch(h){const V=h instanceof Error?h:new Error("Command execution failed");return t.value=V,{ok:!1,error:V}}finally{g.value.delete(c)}}async function i(c){return a("create",()=>m.create(c))}async function s(c,y){return a("update",()=>m.update(c,y))}async function n(c){return a("delete",()=>m.delete(c))}async function l(c,y){return a("duplicate",()=>m.duplicate(c,y))}async function u(c,y,h){return a("linkVariable",()=>m.linkVariableList(c,y,h))}async function f(c,y){return a("unlinkVariable",()=>m.unlinkVariableList(c,y))}async function d(c,y){return a("updateReferences",()=>m.updateVariableListReferences(c,y))}async function w(c){return a("bulkCreate",()=>m.bulkCreate(c))}async function b(c){return a("bulkUpdate",()=>m.bulkUpdate(c))}async function v(c){return a("bulkDelete",()=>m.bulkDelete(c))}async function E(c){return a("import",()=>m.importTemplates(c))}async function O(c){return a("export",()=>m.exportTemplates(c))}async function I(c){return a("validate",()=>m.validateTemplateIntegrity(c))}async function z(){return a("cleanup",()=>m.cleanupInvalidReferences())}return{createTemplate:i,updateTemplate:s,deleteTemplate:n,duplicateTemplate:l,linkVariableList:u,unlinkVariableList:f,updateVariableListReferences:d,bulkCreateTemplates:w,bulkUpdateTemplates:b,bulkDeleteTemplates:v,importTemplates:E,exportTemplates:O,validateTemplateIntegrity:I,cleanupInvalidReferences:z,isExecuting:e,lastError:t,clearError:r}}export{x as u};
