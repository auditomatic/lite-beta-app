var e=Object.defineProperty,t=(t,r,a)=>((t,r,a)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[r]=a)(t,"symbol"!=typeof r?r+"":r,a);import{ag as r,f as a,c as s,ai as n}from"./vendor-BiapkIQZ.js";import{l as o}from"./db-CL8uhZCz.js";import{d as i}from"./index-JPKDQHeA.js";import{g as l}from"./defaultData-DyqJdH2z.js";import{v as c}from"./variables-db-CPg65Q8f.js";import{p as u}from"./registry-CD_hKmbW.js";import{l as d}from"./logger.service-_k__GSpu.js";const p=new class{extractVariables(e){const t=[...e.matchAll(/\{\{(\w+)\}\}/g)];return[...new Set(t.map(e=>e[1]))]}validateTemplate(e){const t=[];if(!e.trim())return{isValid:!1,errors:["Template cannot be empty"],variables:[]};(e.match(/\{\{/g)||[]).length!==(e.match(/\}\}/g)||[]).length&&t.push("Mismatched braces - ensure all {{variables}} are properly closed");/\{\{[^}]*\{\{/.test(e)&&t.push("Nested braces are not allowed");/\{\{\s*\}\}/.test(e)&&t.push("Empty variable placeholders are not allowed");const r=e.match(/\{\{([^}]*)\}\}/g)?.filter(e=>{const t=e.slice(2,-2).trim();return!/^\w+$/.test(t)});r&&r.length>0&&t.push("Variable names must contain only letters, numbers, and underscores");const a=this.extractVariables(e);return{isValid:0===t.length,errors:t,variables:a}}createTestPrompt(e,t,r=0){let a=e;for(const[s,n]of Object.entries(t))if(n&&n.length>0){const e=n[r%n.length]||n[0];a=a.replace(new RegExp(`\\{\\{${s}\\}\\}`,"g"),e)}return a}renderTemplate(e,t){let r=e;for(const[a,s]of Object.entries(t))r=r.replace(new RegExp(`\\{\\{${a}\\}\\}`,"g"),s);return r}getMissingVariables(e,t){return this.extractVariables(e).filter(e=>!t[e]||0===t[e]?.length)}},g=class e{calculateTotalPermutations(e){const t=Object.values(e).filter(e=>e>0);return 0===t.length?0:t.reduce((e,t)=>e*t,1)}getPermutationInfo(t){const r=this.calculateTotalPermutations(t);let a,s;return a=r>999999?`${(r/1e6).toFixed(1)}M`:r>9999?`${(r/1e3).toFixed(0)}k`:r.toLocaleString(),r>e.VERY_LARGE_THRESHOLD?s="Very large trial - may take hours and significant API costs":r>e.LARGE_THRESHOLD&&(s="Large trial - consider sampling or filtering"),{total:r,isLarge:r>e.LARGE_THRESHOLD,formatted:a,warning:s}}*generatePermutations(e,t=1/0){const r=Object.keys(e),a=r.map(t=>e[t]);if(0===r.length)return;let s=0;const n=function*(e,o){if(s>=t)return;if(e===r.length)return yield{...o},void s++;const i=r[e],l=a[e];for(const r of l){if(s>=t)return;o[i]=r,yield*n(e+1,o)}};yield*n(0,{})}getSamplePermutations(e,t=5){const r=[],a=this.generatePermutations(e,t);for(const s of a)r.push(s);return r}estimateTrialMetrics(e,t,r=2e3,a=.01){const s=e*t,n=s*r*.7;return{totalCalls:s,estimatedTimeMinutes:Math.ceil(n/6e4),estimatedCostUSD:s*a}}shouldSample(t,r=e.LARGE_THRESHOLD){const a=this.calculateTotalPermutations(t);if(a<=r)return{shouldSample:!1};let s;return s=a>1e6?1e3:a>1e5?5e3:Math.min(1e4,Math.floor(.1*a)),{shouldSample:!0,recommendedSampleSize:s}}*generateStratifiedSample(e,t){const r=this.calculateTotalPermutations(Object.fromEntries(Object.entries(e).map(([e,t])=>[e,t.length])));if(r<=t)return void(yield*this.generatePermutations(e));const a=Math.floor(r/t);let s=0,n=0;for(const o of this.generatePermutations(e))if(s%a===0&&n<t&&(yield o,n++),s++,n>=t)break}};t(g,"LARGE_THRESHOLD",1e4),t(g,"VERY_LARGE_THRESHOLD",1e5);const m=new g;class h{flattenParameters(e,t=""){const r={};return Object.entries(e).forEach(([e,a])=>{const s=t?`${t}.${e}`:e;a&&"object"==typeof a&&!Array.isArray(a)?Object.assign(r,this.flattenParameters(a,s)):r[s]=a}),r}unflattenParameters(e){const t={};return Object.entries(e).forEach(([e,r])=>{if(e.includes(".")){const a=e.split(".");let s=t;for(let e=0;e<a.length-1;e++)a[e]in s||(s[a[e]]={}),s=s[a[e]];s[a[a.length-1]]=r}else t[e]=r}),t}getOutputTokenLimit(e,t,r){const a=u.getProvider(e);if(!a)return 128;const s=a.modelRules.find(e=>new RegExp(e.pattern).test(t));if(!s)return 128;const n=this.unflattenParameters(r);return this.findOutputLengthValue(s.params,n)??128}findOutputLengthValue(e,t){if(e&&t)for(const[r,a]of Object.entries(e)){if(!0===a.is_output_length)return t[r]??a.default;if("object"===a.type&&a.properties){const e=this.findOutputLengthValue(a.properties,t[r]||{});if(void 0!==e)return e}}}buildAPIRequest(e,t,r,a,s){const n=u.getProvider(e.provider);if(!n)throw new Error(`Unknown provider: ${e.provider}`);const o=n.api.endpoints.chat||n.api.endpoints.generate;if(!o)throw new Error(`No endpoint configured for provider: ${e.provider}`);const i=`${a||n.api.baseUrl}${o}`,l=this.buildHeaders(n,r);let c=t;s?.promptTransform?.append&&(c=t+s.promptTransform.append);return{url:i,method:"POST",headers:l,body:this.buildRequestBody(n,e,c)}}buildHeaders(e,t){const r={"Content-Type":"application/json"};return e.headers&&Object.assign(r,e.headers),"none"!==e.auth.type&&t&&("bearer"===e.auth.type?r.Authorization=`Bearer ${t}`:"header"===e.auth.type&&e.auth.header&&(r[e.auth.header]=t)),r}buildRequestBody(e,t,r){const a=e.requestTransform,s=this.unflattenParameters({...t.params});let n={model:t.model.startsWith(`${t.provider}:`)?t.model.substring(t.provider.length+1):t.model};return a?.promptKey&&(a.wrapPrompt?n[a.promptKey]=[{role:a.messageRole||"user",content:r}]:n[a.promptKey]=r),a?.nestParams?n[a.nestParams]=s:Object.assign(n,s),n=this.applyProviderSpecificTransforms(e.id,n),n}applyProviderSpecificTransforms(e,t){switch(e){case"openai-chat":t.response_format&&"string"==typeof t.response_format&&(t.response_format={type:t.response_format});break;case"openai-responses":t.messages&&(t.input=t.messages[0].content,delete t.messages);break;case"anthropic":if(t.messages&&void 0===t.max_tokens)throw new Error("Anthropic requires max_tokens parameter")}return t}extractResponseContent(e,t){if(!t||"object"!=typeof t)return"";switch(e){case"openai-chat":case"openrouter":return t.choices?.[0]?.message?.content||"";case"openai-responses":const e=t.output?.[0];if("message"===e?.type){const t=e.content?.[0];if("output_text"===t?.type)return t.text||""}return"";case"anthropic":const r=t.content?.[0];return"text"===r?.type?r.text||"":r?.text||"";case"ollama-chat":return t.message?.content||"";case"ollama-generate":return t.response||"";default:return t.content||t.response||t.choices?.[0]?.message?.content||t.message?.content||""}}extractUsageInfo(e,t){if(!t||"object"!=typeof t)return{};switch(e){case"openai-chat":case"openrouter":return{prompt_tokens:t.usage?.prompt_tokens,completion_tokens:t.usage?.completion_tokens,total_tokens:t.usage?.total_tokens};case"openai-responses":return{prompt_tokens:t.usage?.input_tokens,completion_tokens:t.usage?.output_tokens,total_tokens:t.usage?.total_tokens};case"anthropic":return{prompt_tokens:t.usage?.input_tokens,completion_tokens:t.usage?.output_tokens,total_tokens:(t.usage?.input_tokens||0)+(t.usage?.output_tokens||0)};case"ollama-chat":case"ollama-generate":return{prompt_tokens:t.prompt_eval_count,completion_tokens:t.eval_count,total_tokens:(t.prompt_eval_count||0)+(t.eval_count||0)};default:return{}}}isErrorResponse(e){return!e||(!(!e.error&&!e.errors)||(!!(e.status&&e.status>=400)||"error"===e.type))}extractErrorMessage(e){return e?e.error?.message?e.error.message:e.error&&"string"==typeof e.error?e.error:e.message&&"error"===e.type?e.message:e.errors?.[0]?.message?e.errors[0].message:JSON.stringify(e):"Empty response"}}const f=new h;function k(e){return new Worker(""+new URL("token-calculation.worker-Bs6FCesY.js",import.meta.url).href,{name:e?.name})}const w=new class{constructor(){t(this,"worker",null),t(this,"pendingRequests",new Map),t(this,"isWorkerSupported","undefined"!=typeof Worker),t(this,"workerLoadError",null),this.isWorkerSupported&&this.initializeWorker()}initializeWorker(){try{this.worker=new k,this.worker.addEventListener("message",this.handleWorkerMessage.bind(this)),this.worker.addEventListener("error",this.handleWorkerError.bind(this))}catch(e){console.error("Failed to initialize token calculation worker:",e),this.workerLoadError=e,this.isWorkerSupported=!1}}handleWorkerMessage(e){const t=e.data,r=this.pendingRequests.get(t.id);if(r)switch(t.type){case"progress":r.onProgress?.(t);break;case"result":r.resolve(t.result),this.pendingRequests.delete(t.id);break;case"error":r.reject(new Error(t.error.message)),this.pendingRequests.delete(t.id)}else console.warn("Received message for unknown request:",t.id)}handleWorkerError(e){console.error("Worker error:",e),this.pendingRequests.forEach(e=>{e.reject(new Error("Worker crashed"))}),this.pendingRequests.clear(),this.worker?.terminate(),this.worker=null,setTimeout(()=>{this.isWorkerSupported&&this.initializeWorker()},1e3)}async prepareDesignData(e){const t={...e.variableBindings};for(const[a,s]of Object.entries(e.variableBindings||{}))if("list"===s.type&&s.listId)try{const e=await c.getListValues(s.listId);t[a]={type:"direct",values:e}}catch(r){console.warn(`Failed to resolve list values for ${a}:`,r),t[a]={type:"direct",values:[]}}return{id:e.id,promptTemplate:e.promptTemplate,variableBindings:t}}async calculateApproximate(e){if(!this.isWorkerSupported||!this.worker)return this.calculateApproximateMainThread(e);const t=`${e.id}-${Date.now()}-${Math.random()}`,r=await this.prepareDesignData(e);return new Promise((e,a)=>{this.pendingRequests.set(t,{resolve:e,reject:a});const s={id:t,method:"approximate",design:r};this.worker.postMessage(s),setTimeout(()=>{this.pendingRequests.has(t)&&(this.pendingRequests.delete(t),a(new Error("Worker timeout")))},5e3)})}async calculateAccurate(e,t){if(!this.isWorkerSupported||!this.worker)return console.warn("Worker not available, falling back to approximate calculation"),this.calculateApproximateMainThread(e);const r=`${e.id}-${Date.now()}-${Math.random()}`,a=await this.prepareDesignData(e);return new Promise((e,s)=>{this.pendingRequests.set(r,{resolve:e,reject:s,onProgress:t});const n={id:r,method:"accurate",design:a};this.worker.postMessage(n),setTimeout(()=>{this.pendingRequests.has(r)&&(this.pendingRequests.delete(r),s(new Error("Worker timeout - calculation taking too long")))},6e4)})}async calculateApproximateMainThread(e){const t=e=>Math.ceil(e.length/4),r=e.promptTemplate.replace(/\{\{[^}]+\}\}/g,""),a=t(r),s={};for(const[u,d]of Object.entries(e.variableBindings||{}))if("direct"===d.type&&d.values)s[u]=d.values;else if("list"===d.type&&d.listId)try{s[u]=await c.getListValues(d.listId)}catch{s[u]=[]}const n={};for(const[c,u]of Object.entries(s)){if(0===u.length){n[c]={min:0,max:0,avg:0};continue}const e=u.map(e=>t(e));n[c]={min:Math.min(...e),max:Math.max(...e),avg:Math.round(e.reduce((e,t)=>e+t,0)/e.length)}}let o=a,i=a,l=a;for(const c of Object.values(n))o+=c.min,i+=c.max,l+=c.avg;return{minTokens:o,maxTokens:i,avgTokens:l,sampleSize:Object.values(s).reduce((e,t)=>e+t.length,0),calculated:new Date,isAccurate:!1}}isWorkerAvailable(){return this.isWorkerSupported&&null!==this.worker&&null===this.workerLoadError}terminate(){this.worker&&(this.pendingRequests.forEach(e=>{e.reject(new Error("Worker terminated"))}),this.pendingRequests.clear(),this.worker.terminate(),this.worker=null)}};const v=new class{constructor(){t(this,"tokenCountCache",new Map)}async calculateDesignTokens(e){try{const r=this.getDesignCacheKey(e),a=this.tokenCountCache.get(r);if(a&&a.calculated&&Date.now()-a.calculated.getTime()<36e5)return a;if(e.name,w.isWorkerAvailable())try{const t=await w.calculateApproximate(e);return e.name,this.tokenCountCache.set(r,t),t}catch(t){console.warn("Worker calculation failed, falling back to main thread:",t)}const s=e.promptTemplate.replace(/\{\{[^}]+\}\}/g,""),n=await this.countTokens(s),o=await this.getVariableValues(e),i={};for(const[e,t]of Object.entries(o)){if(0===t.length){i[e]={min:0,max:0,avg:0};continue}const r=await Promise.all(t.map(e=>this.countTokens(e)));i[e]={min:Math.min(...r),max:Math.max(...r),avg:Math.round(r.reduce((e,t)=>e+t,0)/r.length)}}let l=n,c=n,u=n;for(const e of Object.values(i))l+=e.min,c+=e.max,u+=e.avg;const d={minTokens:l,maxTokens:c,avgTokens:u,sampleSize:Object.values(o).reduce((e,t)=>e+t.length,0),calculated:new Date,isAccurate:!1};return e.name,this.tokenCountCache.set(r,d),d}catch(r){return console.error("Failed to calculate design tokens:",r),{minTokens:0,maxTokens:0,avgTokens:0,sampleSize:0,calculated:new Date}}}async calculateDesignTokensAccurate(e,t){try{const a=this.getDesignCacheKey(e)+":accurate",s=this.tokenCountCache.get(a);if(s&&s.calculated&&s.isAccurate&&Date.now()-s.calculated.getTime()<36e5)return s;if(w.isWorkerAvailable())try{const r=await w.calculateAccurate(e,t?e=>{t({stage:e.stage,current:e.current,total:e.total,message:e.message})}:void 0);return e.name,this.tokenCountCache.set(a,r),r}catch(r){return console.warn("Worker accurate calculation failed, falling back to approximate:",r),this.calculateDesignTokens(e)}return console.warn("Worker not available for accurate calculation, using approximate"),this.calculateDesignTokens(e)}catch(a){return console.error("Failed to calculate accurate tokens:",a),this.calculateDesignTokens(e)}}async calculateCostEstimate(e,t,r){const a=await this.calculateDesignTokens(e),s=this.getOutputTokenLimit(t.provider,t.modelId,r),n=t.capabilities?.inputCostPerToken||0,o=t.capabilities?.outputCostPerToken||0,i={min:a.minTokens*n+s*o,max:a.maxTokens*n+s*o,avg:a.avgTokens*n+s*o},l=await this.getVariableCounts(e),c=m.calculateTotalPermutations(l);return{inputTokens:a,outputTokens:s,costPerCall:i,totalCost:{min:i.min*c,max:i.max*c,avg:i.avg*c}}}getOutputTokenLimit(e,t,r){return f.getOutputTokenLimit(e,t,r)}async countTokens(e){return e&&0!==e.length?Math.ceil(e.length/4):0}async getVariableCounts(e){const t={};for(const[r,a]of Object.entries(e.variableBindings||{}))if("direct"===a.type&&a.values)t[r]=a.values.length;else if("list"===a.type&&a.listId){const e=await c.getListValues(a.listId);t[r]=e.length}return t}async getVariableValues(e){const t={};try{for(const[a,s]of Object.entries(e.variableBindings||{}))if("direct"===s.type&&s.values)t[a]=s.values;else if("list"===s.type&&s.listId)try{const e=await c.getListValues(s.listId);t[a]=e}catch(r){console.warn(`Failed to get list values for ${a}:`,r),t[a]=[]}}catch(r){console.error("Error getting variable values:",r)}return t}getDesignCacheKey(e){const t=JSON.stringify(e.variableBindings);return`${e.id}:${e.promptTemplate}:${t}`}clearCache(){this.tokenCountCache.clear()}},b=r("designs",()=>{const e=a([]),t=a(!1),r=a(null);let c=null;async function u(e){const t=new Date,r=l(),a=p.validateTemplate(e.promptTemplate);if(!a.isValid)throw new Error(`Invalid template: ${a.errors.join(", ")}`);let s;if(e.variableBindings&&Object.keys(e.variableBindings).length>0)try{s=await v.calculateDesignTokens({...e,id:r,created:t,updated:t})}catch(o){d.warn("Failed to calculate token estimate:",{error:o})}const n={...e,id:r,created:t,updated:t,tokenEstimate:s};try{return await i.designs.add(n),r}catch(o){throw d.error("Failed to create design",o),new Error("Failed to create design")}}async function g(e){try{const t=await i.designs.get(e);return d.debug("getDesign retrieved",{id:e,found:!!t}),t}catch(t){return void d.error("Failed to get design",t)}}const m=s(()=>e.value.map(e=>{const t=p.extractVariables(e.promptTemplate),r=Object.values(e.variableBindings||{}).some(e=>"list"===e.type);return{...e,variableCount:t.length,hasExtraction:!!e.extractPattern,hasListRefs:r}})),h=s(()=>e.value.slice().sort((e,t)=>t.updated.getTime()-e.updated.getTime())),f=s(()=>h.value.slice(0,5));return{designs:n(e),isLoading:n(t),error:n(r),designsWithStats:m,designsByDate:h,recentDesigns:f,initialize:async function(){if(!c){t.value=!0,r.value=null;try{c=o(()=>i.designs.orderBy("updated").reverse().toArray()).subscribe({next:async r=>{e.value=r,t.value=!1,r.length>0&&setTimeout(()=>{!async function(e){const t=e.filter(e=>!e.tokenEstimate&&e.variableBindings&&Object.keys(e.variableBindings).length>0);if(0===t.length)return;d.debug(`Starting background token calculation for ${t.length} designs`);const r=t.map(async e=>{try{const t=await v.calculateDesignTokens(e);await i.designs.update(e.id,{tokenEstimate:t}),d.debug(`Background token calculation complete for: ${e.name}`)}catch(t){d.warn(`Background token calculation failed for ${e.name}:`,{error:t})}});Promise.all(r).then(()=>{d.debug("All background token calculations complete")})}(r)},500)},error:e=>{d.error("Designs store subscription error",e),r.value="Failed to load designs",t.value=!1}})}catch(a){d.error("Failed to initialize designs store",a),r.value="Failed to initialize designs",t.value=!1}}},createDesign:u,updateDesign:async function(e,t){try{if(void 0!==t.promptTemplate){const e=p.validateTemplate(t.promptTemplate);if(!e.isValid)throw new Error(`Invalid template: ${e.errors.join(", ")}`)}const a=await i.designs.get(e);if(!a)throw new Error("Design not found");let s=a.tokenEstimate;if(void 0!==t.promptTemplate||void 0!==t.variableBindings){const e={...a,...t};if(e.variableBindings&&Object.keys(e.variableBindings).length>0)try{s=await v.calculateDesignTokens(e)}catch(r){d.warn("Failed to calculate token estimate:",{error:r})}else s=void 0}d.debug("updateDesign called",{id:e,changes:t}),await i.designs.update(e,{...t,tokenEstimate:s,updated:new Date}),d.debug("Design updated successfully",{id:e})}catch(r){throw d.error("Failed to update design",r),new Error("Failed to update design")}},deleteDesign:async function(e){try{if(await i.trials.where("designId").equals(e).count()>0)throw new Error("Cannot delete design - it is used in existing trials");await i.designs.delete(e)}catch(t){if(d.error("Failed to delete design",t),t instanceof Error)throw t;throw new Error("Failed to delete design")}},getDesign:g,getAllDesigns:async function(){try{return await i.designs.toArray()}catch(e){return d.error("Failed to get all designs",e),[]}},duplicateDesign:async function(t,r){const a=await g(t);if(!a)throw new Error("Design not found");const s=r||`${a.name} (copy)`;let n=s,o=1;for(;e.value.some(e=>e.name===n);)n=`${s} ${o}`,o++;return u({name:n,description:a.description,promptTemplate:a.promptTemplate,variableBindings:a.variableBindings,outputType:a.outputType,extractPattern:a.extractPattern,refusalWords:a.refusalWords,rejectRefusalWords:a.rejectRefusalWords})},searchDesigns:t=>{if(!t.trim())return e.value;const r=t.toLowerCase().trim();return e.value.filter(e=>{if(e.name.toLowerCase().includes(r)||e.description?.toLowerCase().includes(r))return!0;return p.extractVariables(e.promptTemplate).some(e=>e.toLowerCase().includes(r))})},destroy:function(){c&&(c.unsubscribe(),c=null)}}});export{h as P,v as a,f as b,m as p,p as t,b as u};
