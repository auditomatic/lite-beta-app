var __defProp=Object.defineProperty,__defNormalProp=(e,t,n)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,__publicField=(e,t,n)=>__defNormalProp(e,"symbol"!=typeof t?t+"":t,n);!function(){"use strict";for(var e={byteLength:function(e){var t=s(e),n=t[0],r=t[1];return 3*(n+r)/4-r},toByteArray:function(e){var t,o,a=s(e),i=a[0],c=a[1],l=new r(function(e,t,n){return 3*(t+n)/4-n}(0,i,c)),u=0,d=c>0?i-4:i;for(o=0;o<d;o+=4)t=n[e.charCodeAt(o)]<<18|n[e.charCodeAt(o+1)]<<12|n[e.charCodeAt(o+2)]<<6|n[e.charCodeAt(o+3)],l[u++]=t>>16&255,l[u++]=t>>8&255,l[u++]=255&t;2===c&&(t=n[e.charCodeAt(o)]<<2|n[e.charCodeAt(o+1)]>>4,l[u++]=255&t);1===c&&(t=n[e.charCodeAt(o)]<<10|n[e.charCodeAt(o+1)]<<4|n[e.charCodeAt(o+2)]>>2,l[u++]=t>>8&255,l[u++]=255&t);return l},fromByteArray:function(e){for(var n,r=e.length,o=r%3,a=[],s=16383,i=0,l=r-o;i<l;i+=s)a.push(c(e,i,i+s>l?l:i+s));1===o?(n=e[r-1],a.push(t[n>>2]+t[n<<4&63]+"==")):2===o&&(n=(e[r-2]<<8)+e[r-1],a.push(t[n>>10]+t[n>>4&63]+t[n<<2&63]+"="));return a.join("")}},t=[],n=[],r="undefined"!=typeof Uint8Array?Uint8Array:Array,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0;a<64;++a)t[a]=o[a],n[o.charCodeAt(a)]=a;function s(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function i(e){return t[e>>18&63]+t[e>>12&63]+t[e>>6&63]+t[63&e]}function c(e,t,n){for(var r,o=[],a=t;a<n;a+=3)r=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),o.push(i(r));return o.join("")}n["-".charCodeAt(0)]=62,n["_".charCodeAt(0)]=63;var l=Object.defineProperty;function u(e,t){return 1===e.length?[t.get(e.join(","))]:function(e,t){let n=Array.from({length:e.length},(e,t)=>({start:t,end:t+1}));for(;n.length>1;){let r=null;for(let o=0;o<n.length-1;o++){const a=e.slice(n[o].start,n[o+1].end),s=t.get(a.join(","));null!=s&&(null==r||s<r[0])&&(r=[s,o])}if(null==r)break;{const e=r[1];n[e]={start:n[e].start,end:n[e+1].end},n.splice(e+1,1)}}return n}(e,t).map(n=>t.get(e.slice(n.start,n.end).join(","))).filter(e=>null!=e)}var d=class{constructor(t,n){__publicField(this,"specialTokens"),__publicField(this,"inverseSpecialTokens"),__publicField(this,"patStr"),__publicField(this,"textEncoder",new TextEncoder),__publicField(this,"textDecoder",new TextDecoder("utf-8")),__publicField(this,"rankMap",new Map),__publicField(this,"textMap",new Map),this.patStr=t.pat_str;const r=t.bpe_ranks.split("\n").filter(Boolean).reduce((e,t)=>{const[n,r,...o]=t.split(" "),a=Number.parseInt(r,10);return o.forEach((t,n)=>e[t]=a+n),e},{});for(const[o,a]of Object.entries(r)){const t=e.toByteArray(o);this.rankMap.set(t.join(","),a),this.textMap.set(a,t)}this.specialTokens={...t.special_tokens,...n},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((e,[t,n])=>(e[n]=this.textEncoder.encode(t),e),{})}encode(e,t=[],n="all"){const r=new RegExp(this.patStr,"ug"),o=d.specialTokenRegex(Object.keys(this.specialTokens)),a=[],s=new Set("all"===t?Object.keys(this.specialTokens):t),i=new Set("all"===n?Object.keys(this.specialTokens).filter(e=>!s.has(e)):n);if(i.size>0){const t=d.specialTokenRegex([...i]),n=e.match(t);if(null!=n)throw new Error(`The text contains a special token that is not allowed: ${n[0]}`)}let c=0;for(;;){let t=null,n=c;for(;o.lastIndex=n,t=o.exec(e),null!=t&&!s.has(t[0]);)n=t.index+1;const i=t?.index??e.length;for(const o of e.substring(c,i).matchAll(r)){const e=this.textEncoder.encode(o[0]),t=this.rankMap.get(e.join(","));null==t?a.push(...u(e,this.rankMap)):a.push(t)}if(null==t)break;let l=this.specialTokens[t[0]];a.push(l),c=t.index+t[0].length}return a}decode(e){const t=[];let n=0;for(let a=0;a<e.length;++a){const r=e[a],o=this.textMap.get(r)??this.inverseSpecialTokens[r];null!=o&&(t.push(o),n+=o.length)}const r=new Uint8Array(n);let o=0;for(const a of t)r.set(a,o),o+=a.length;return this.textDecoder.decode(r)}},h=d;function p(e){self.postMessage(e)}function f(e){return Math.ceil(e.length/4)}async function g(e){const t={};for(const[n,r]of Object.entries(e||{}))"direct"===r.type&&r.values?t[n]=r.values:"list"===r.type&&(t[n]=[]);return t}((e,t,n)=>{t in e?l(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(h,"specialTokenRegex"+"",e=>new RegExp(e.map(e=>e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")).join("|"),"g"));let m=null;async function k(e){const{id:t,design:n}=e;try{p({id:t,type:"progress",stage:"preparing",current:0,total:1,message:"Loading tiktoken encoder..."});const e=await async function(){if(m)return m;try{const e=await fetch("https://tiktoken.pages.dev/js/o200k_base.json"),t=await e.json();return m=new h(t),m}catch(e){throw new Error(`Failed to load tiktoken: ${e instanceof Error?e.message:"Unknown error"}`)}}(),r=n.promptTemplate.replace(/\{\{[^}]+\}\}/g,""),o=e.encode(r).length,a=await g(n.variableBindings),s=Object.values(a).reduce((e,t)=>e+t.length,0);let i=0;const c={};for(const[n,h]of Object.entries(a)){if(0===h.length){c[n]={min:0,max:0,avg:0};continue}const r=[],o=50;for(let a=0;a<h.length;a+=o){const c=h.slice(a,a+o);for(const o of c){const a=e.encode(o).length;r.push(a),i++,i%10==0&&p({id:t,type:"progress",stage:"encoding",current:i,total:s,message:`Processing ${n}: ${Math.round(i/s*100)}%`})}}c[n]={min:Math.min(...r),max:Math.max(...r),avg:Math.round(r.reduce((e,t)=>e+t,0)/r.length)}}let l=o,u=o,d=o;for(const t of Object.values(c))l+=t.min,u+=t.max,d+=t.avg;p({id:t,type:"progress",stage:"complete",current:s,total:s,message:"Token calculation complete!"}),p({id:t,type:"result",result:{minTokens:l,maxTokens:u,avgTokens:d,sampleSize:s,calculated:new Date,isAccurate:!0}})}catch(r){let e="Unknown error occurred",n="ACCURATE_CALC_ERROR";r instanceof Error&&(e=r.message,r.message.includes("Failed to fetch")||r.message.includes("NetworkError")?(e="Failed to download tiktoken library. Please check your internet connection and try again.",n="TIKTOKEN_DOWNLOAD_ERROR"):r.message.includes("import")&&(e="Failed to load tiktoken library. This feature may not be available in your browser.",n="TIKTOKEN_IMPORT_ERROR")),p({id:t,type:"error",error:{message:e,code:n}})}}self.addEventListener("message",async e=>{const t=e.data;switch(t.method){case"approximate":await async function(e){const{id:t,design:n}=e;try{const e=f(n.promptTemplate.replace(/\{\{[^}]+\}\}/g,"")),r=await g(n.variableBindings),o={};for(const[t,n]of Object.entries(r)){if(0===n.length){o[t]={min:0,max:0,avg:0};continue}const e=n.map(e=>f(e));o[t]={min:Math.min(...e),max:Math.max(...e),avg:Math.round(e.reduce((e,t)=>e+t,0)/e.length)}}let a=e,s=e,i=e;for(const t of Object.values(o))a+=t.min,s+=t.max,i+=t.avg;p({id:t,type:"result",result:{minTokens:a,maxTokens:s,avgTokens:i,sampleSize:Object.values(r).reduce((e,t)=>e+t.length,0),calculated:new Date,isAccurate:!1}})}catch(r){p({id:t,type:"error",error:{message:r instanceof Error?r.message:"Unknown error",code:"APPROXIMATE_CALC_ERROR"}})}}(t);break;case"accurate":await k(t);break;default:p({id:t.id,type:"error",error:{message:`Unknown method: ${t.method}`,code:"UNKNOWN_METHOD"}})}})}();
