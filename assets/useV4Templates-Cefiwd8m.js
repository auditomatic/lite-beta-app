import{c as o,l as g,d as v,a as p}from"./index-Be9cnb4G.js";import{u as d}from"./useV4LiveQuery-Du2rfIZ0.js";import{u as R}from"./useV4VariableLists-BT4miRvE.js";function x(){const{data:m,loading:y,error:h}=d(()=>g(()=>v.template_prompts.orderBy("updated").reverse().toArray()),e=>Object.freeze(e.map(t=>Object.freeze(t))),{initialValue:[],shallow:!0}),{data:L,loading:j}=d(()=>g(()=>v.variableLists.toArray()),e=>Object.freeze(e.map(t=>Object.freeze(t))),{initialValue:[],shallow:!0}),O=o(()=>y.value||j.value),z=o(()=>h.value),l=o(()=>{if(m.value.length===0)return[];const e=new Map(L.value.map(a=>[a.id,a])),t=m.value.map(a=>{const i=Object.keys(a.variables||{}).length;let n=1;const c={},u=[];if(a.variables)for(const[b,s]of Object.entries(a.variables))if(s.type==="list"&&s.listId){const r=e.get(s.listId);r?(c[b]=r,r.category==="simple"&&r.values?n*=r.values.length:r.category==="attributed"&&r.items?n*=r.items.length:r.category==="refusal"&&r.values?n*=r.values.length:r.category==="tabular"&&r.itemCount&&(n*=r.itemCount)):u.push(s.listId)}else s.type==="value"&&s.values&&(n*=s.values.length);const f={...a,variableCount:i,combinationCount:n,tokenEstimate:Math.ceil(a.template.length/4),variableListData:Object.keys(c).length>0?Object.freeze(c):void 0,missingVariableLists:u.length>0?Object.freeze(u):void 0};return Object.freeze(f)});return Object.freeze(t)}),C=o(()=>{const e={};for(const t of l.value){const a=t.category||"Uncategorized";e[a]||(e[a]=[]),e[a].push(t)}for(const t in e)e[t]=Object.freeze(e[t]);return Object.freeze(e)}),V=o(()=>Object.freeze(l.value.filter(e=>!e.isDefault))),T=o(()=>Object.freeze(l.value.filter(e=>e.isDefault))),w=o(()=>Object.freeze(Array.from(new Set(l.value.map(e=>e.category||"Uncategorized"))).sort())),B=o(()=>Object.freeze(l.value.filter(e=>e.variableListData))),D=o(()=>Object.freeze(l.value.filter(e=>e.missingVariableLists&&e.missingVariableLists.length>0)));function k(e){return o(()=>{const t=l.value.find(a=>a.id===e);return t?Object.freeze(t):null})}function W(e){return o(()=>Object.freeze(l.value.filter(t=>(t.category||"Uncategorized")===e)))}function I(e){return o(()=>{if(!e.trim())return l.value;const t=e.toLowerCase(),a=l.value.filter(i=>{var n,c;return i.name.toLowerCase().includes(t)||((n=i.description)==null?void 0:n.toLowerCase().includes(t))||i.template.toLowerCase().includes(t)||((c=i.category)==null?void 0:c.toLowerCase().includes(t))||i.tags.some(u=>u.toLowerCase().includes(t))});return Object.freeze(a)})}function U(e){return o(()=>{const t=l.value.filter(a=>a.variables?Object.values(a.variables).some(i=>i.type==="list"&&i.listId===e):!1);return Object.freeze(t)})}const P=o(()=>{const e=l.value,t=e.length;if(t===0)return Object.freeze({total:0,byCategory:{},totalVariables:0,avgVariablesPerTemplate:0,templatesWithVariableLists:0,templatesWithBrokenReferences:0,mostPopularCategory:null,totalCombinations:0});const a={};let i=0,n=0,c=0,u=0;for(const s of e){const r=s.category||"Uncategorized";a[r]=(a[r]||0)+1,i+=s.variableCount||0,u+=s.combinationCount||0,s.variableListData&&n++,s.missingVariableLists&&s.missingVariableLists.length>0&&c++}let f=null,b=0;for(const[s,r]of Object.entries(a))r>b&&(b=r,f=s);return Object.freeze({total:t,byCategory:Object.freeze(a),totalVariables:i,avgVariablesPerTemplate:t>0?Math.round(i/t):0,templatesWithVariableLists:n,templatesWithBrokenReferences:c,mostPopularCategory:f,totalCombinations:u})});return R(e=>{e.table==="templates"?p.info("V4 Cross-tab update received for templates:",e.operation):e.table==="variableLists"&&p.info("V4 Cross-tab update received for variableLists (template enrichment):",e.operation)}),{templates:l,templatesByCategory:C,customTemplates:V,defaultTemplates:T,loading:O,error:z,templatesWithVariableListData:B,templatesWithBrokenReferences:D,getTemplateById:k,getTemplatesByCategory:W,searchTemplates:I,getTemplatesUsingVariableList:U,stats:P,categories:w}}export{x as u};
