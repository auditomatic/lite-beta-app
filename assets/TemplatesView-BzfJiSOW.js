const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-COu0csOc.js","./vendor-CdfxntmD.js","./db-CL8uhZCz.js","./index-C3dOhsog.css"])))=>i.map(i=>d[i]);
import{c as e,r as a,f as t,w as l,d as s,ab as i,_ as r,a1 as n,a0 as o,k as u,a3 as d,F as c,ac as v,ag as m,$ as p,G as f,q as g,Y as b,ad as y,ah as h,B as k,b as _,Z as w,u as x,a4 as C,h as I,o as V,W as T,X as L,n as D}from"./vendor-CdfxntmD.js";import{_ as R,u as S}from"./BaseButton.vue_vue_type_style_index_0_lang-DGlOSN5T.js";import{u as E}from"./useLiveData-D-xinmMz.js";import{l as P,d as $,v as N,_ as W,w as j,x as A,y as U,m as z,z as F,G as O,H as B,J as M,e as K,f as q,K as H}from"./index-COu0csOc.js";import{p as J,t as G}from"./token-calculation.service-DxLNJTZv.js";import{u as Y}from"./useLiveDataSingle-X0OuE1-_.js";import{_ as X}from"./BaseModal.vue_vue_type_style_index_0_lang-DY82666A.js";import{a as Z}from"./cost-formatting-DSpbVMtV.js";import{u as Q}from"./useEnvironmentalCost-DUUqz85l.js";import{T as ee}from"./TemplateEditor-0N5BOzn-.js";import"./db-CL8uhZCz.js";import"./variable.service-p5oZZ_-F.js";const ae=/\{\{(\w+)\}\}/g,te=/\{\{/g,le=/\}\}/g,se=/\{\{[^}]*\{\{/,ie=/\{\{\s*\}\}/,re=/\{\{([^}]*)\}\}/g;const ne=new class{extractVariables(e){ae.lastIndex=0;const a=[...e.matchAll(ae)];return[...new Set(a.map(e=>e[1]))]}validateTemplate(e){const a=[];if(!e.trim())return{isValid:!1,errors:["Template cannot be empty"],variables:[]};(e.match(te)||[]).length!==(e.match(le)||[]).length&&a.push("Mismatched braces - ensure all {{variables}} are properly closed");se.test(e)&&a.push("Nested braces are not allowed");ie.test(e)&&a.push("Empty variable placeholders are not allowed"),re.lastIndex=0;const t=e.match(re)?.filter(e=>{const a=e.slice(2,-2).trim();return!/^\w+$/.test(a)});t&&t.length>0&&a.push("Variable names must contain only letters, numbers, and underscores");const l=this.extractVariables(e);return{isValid:0===a.length,errors:a,variables:l}}createTestPrompt(e,a,t=0){let l=e;for(const[s,i]of Object.entries(a))if(i&&i.length>0){const e=i[t%i.length]||i[0];l=l.replace(new RegExp(`\\{\\{${s}\\}\\}`,"g"),e)}return l}renderTemplate(e,a){let t=e;for(const[l,s]of Object.entries(a))t=t.replace(new RegExp(`\\{\\{${l}\\}\\}`,"g"),s);return t}getMissingVariables(e,a){return this.extractVariables(e).filter(e=>!a[e]||0===a[e]?.length)}};const oe={class:"variable-chip-input"},ue={key:0,class:"attributed-list-display"},de={class:"list-header"},ce={class:"source-name"},ve={key:0,class:"attribute-breakdown"},me={key:0,class:"separator"},pe={class:"total-conditions"},fe={class:"attributed-chips-container"},ge={class:"item-name"},be={key:0,class:"attributes-wrapper"},ye={key:1,class:"direct-values"},he={key:0,class:"simple-list-display"},ke={class:"list-header"},_e={class:"source-name"},we={class:"tag-input-wrapper"},xe={class:"custom-tag-input"},Ce={class:"tag-container tag-container-readonly"},Ie=["title"],Ve={key:0,class:"readonly-hint"},Te={key:0,class:"helper-text"},Le={key:1,class:"tag-input-wrapper"},De={class:"custom-tag-input"},Re={class:"tag-container"},Se={class:"floating-actions"},Ee=["title"],Pe=["onClick","data-testid","aria-label"],$e=["placeholder","aria-label","onKeydown"],Ne={key:0,class:"helper-text"},We=W(s({__name:"VariableChipInput",props:{values:{},listRef:{},listName:{},source:{},placeholder:{},attributedSamples:{},attributeBreakdown:{},attributeKeys:{},previewValues:{},totalCount:{}},emits:["update:values","clear-source","clear-list","select-list"],setup(e,{emit:a}){const l=e,s=a,_=t(""),w=t();function x(e){s("update:values",e),l.source&&s("clear-source")}function C(){const e=_.value.trim();e&&(l.values.includes(e)||x([...l.values,e]),_.value="")}function I(e){e.preventDefault();const a=(e.clipboardData?.getData("text")||"").split(/\r?\n/).map(e=>e.trim()).filter(e=>e.length>0);if(a.length>0){const e=new Set(l.values),t=a.filter(a=>!e.has(a));t.length>0&&x([...l.values,...t]),_.value=""}}function V(){if(""===_.value&&l.values.length>0){const e=[...l.values];e.pop(),x(e)}}function T(){x([]),l.source&&s("clear-source")}return(e,a)=>(r(),i("div",oe,[e.listRef&&e.attributedSamples?(r(),i("div",ue,[n("div",de,[a[6]||(a[6]=n("span",{class:"source-label"},"From list:",-1)),n("span",ce,d(e.listName||"Unknown List"),1),e.attributeBreakdown&&e.attributeBreakdown.parts.length>0?(r(),i("div",ve,[(r(!0),i(c,null,v(e.attributeBreakdown.parts,(a,t)=>(r(),i(c,{key:`part-${a.text}-${t}`},[n("span",{class:"attribute-part",style:m({backgroundColor:[{bg:"#d1fae5",text:"#166534"},{bg:"#e9d5ff",text:"#7c2d12"},{bg:"#fed7aa",text:"#c2410c"},{bg:"#fce7f3",text:"#be185d"},{bg:"#fef3c7",text:"#92400e"}][a.colorIndex].bg,color:[{bg:"#d1fae5",text:"#166534"},{bg:"#e9d5ff",text:"#7c2d12"},{bg:"#fed7aa",text:"#c2410c"},{bg:"#fce7f3",text:"#be185d"},{bg:"#fef3c7",text:"#92400e"}][a.colorIndex].text})},d(a.text),5),t<e.attributeBreakdown.parts.length-1?(r(),i("span",me," × ")):o("",!0)],64))),128)),a[4]||(a[4]=n("span",{class:"arrow"}," → ",-1)),n("span",pe,d(e.attributeBreakdown.totalItems)+" conditions",1)])):o("",!0),u(R,{variant:"danger",size:"small",onClick:a[0]||(a[0]=a=>e.$emit("clear-list")),"data-testid":"btn-remove-list","aria-label":"Remove linked variable list"},{default:p(()=>a[5]||(a[5]=[f(" Remove List ")])),_:1,__:[5]})]),n("div",fe,[a[9]||(a[9]=n("span",{class:"sample-hint"},"Sample values:",-1)),(r(!0),i(c,null,v(e.attributedSamples,e=>{return r(),i("div",{key:e.value,class:"attributed-item-chip"},[n("span",ge,d(e.value),1),e.attributes?(r(),i("span",be,[a[7]||(a[7]=f(" (")),(r(!0),i(c,null,v((t=e.attributes,l.attributeKeys?Object.entries(t).map(([e,a])=>({value:a,colorIndex:l.attributeKeys.indexOf(e)%5})):[]),(e,a)=>(r(),i("span",{key:`attr-${e.value}-${a}`,class:"attribute-value",style:m({backgroundColor:[{bg:"#d1fae5",text:"#166534"},{bg:"#e9d5ff",text:"#7c2d12"},{bg:"#fed7aa",text:"#c2410c"},{bg:"#fce7f3",text:"#be185d"},{bg:"#fef3c7",text:"#92400e"}][e.colorIndex].bg,color:[{bg:"#d1fae5",text:"#166534"},{bg:"#e9d5ff",text:"#7c2d12"},{bg:"#fed7aa",text:"#c2410c"},{bg:"#fce7f3",text:"#be185d"},{bg:"#fef3c7",text:"#92400e"}][e.colorIndex].text})},d(e.value),5))),128)),a[8]||(a[8]=f(") "))])):o("",!0)]);var t}),128))])])):(r(),i("div",ye,[e.source?(r(),i("div",he,[n("div",ke,[a[12]||(a[12]=n("span",{class:"source-label"},"From list:",-1)),n("span",_e,d(e.source.listName),1),a[13]||(a[13]=n("span",{class:"edit-hint"},"(Unlink list to edit)",-1)),u(R,{variant:"primary",size:"small",onClick:a[1]||(a[1]=a=>e.$emit("clear-source")),"data-testid":"btn-unlink-list","aria-label":"Unlink list and edit values directly"},{default:p(()=>a[10]||(a[10]=[f(" Unlink List and Edit Directly ")])),_:1,__:[10]}),u(R,{variant:"danger",size:"small",onClick:T,"data-testid":"btn-clear-values","aria-label":"Remove all values from list"},{default:p(()=>a[11]||(a[11]=[f(" Remove List ")])),_:1,__:[11]})]),n("div",we,[n("div",xe,[n("div",Ce,[(r(!0),i(c,null,v(e.values,(e,a)=>(r(),i("div",{key:`${e}-${a}`,class:"tag tag-readonly"},[n("span",{class:"tag-text",title:e.length>100?e:""},d(e.length>100?e.substring(0,100)+"...":e),9,Ie)]))),128)),0===e.values.length?(r(),i("span",Ve," Values from linked list will appear here ")):o("",!0)]),e.values.length>0?(r(),i("div",Te,d(e.values.length)+" values ",1)):o("",!0)])])])):o("",!0),e.source?o("",!0):(r(),i("div",Le,[n("div",De,[n("div",Re,[n("div",Se,[e.values.length>0?(r(),b(R,{key:0,variant:"danger",size:"small",onClick:T,"data-testid":"btn-clear-all","aria-label":"Clear all values"},{default:p(()=>a[14]||(a[14]=[f(" Clear ")])),_:1,__:[14]})):o("",!0),u(R,{variant:"secondary",size:"small",onClick:a[2]||(a[2]=a=>e.$emit("select-list")),"data-testid":"btn-select-list","aria-label":"Replace values with a variable list"},{default:p(()=>a[15]||(a[15]=[f(" Replace with List ")])),_:1,__:[15]})]),(r(!0),i(c,null,v(e.values,(e,a)=>(r(),i("div",{key:`${e}-${a}`,class:"tag"},[n("span",{class:"tag-text",title:e.length>100?e:""},d(e.length>100?e.substring(0,100)+"...":e),9,Ee),n("button",{type:"button",class:"tag-remove",onClick:e=>function(e){const a=[...l.values];a.splice(e,1),x(a)}(a),"data-testid":`btn-remove-tag-${a}`,"aria-label":`Remove value ${e}`}," × ",8,Pe)]))),128)),g(n("input",{ref_key:"inputField",ref:w,"onUpdate:modelValue":a[3]||(a[3]=e=>_.value=e),placeholder:e.placeholder,class:"tag-input-field","data-testid":"input-variable-value","aria-label":e.placeholder||"Enter variable value",onKeydown:[h(k(C,["prevent"]),["enter"]),h(V,["backspace"])],onPaste:I},null,40,$e),[[y,_.value]])]),e.values.length>0?(r(),i("div",Ne,d(e.values.length)+" values ",1)):o("",!0)])]))]))]))}}),[["__scopeId","data-v-1131a54a"]]),je={class:"variable-preview-cycler"},Ae={class:"preview-controls"},Ue={key:0,class:"cycle-info","data-testid":"cycle-info",role:"status","aria-live":"polite"},ze=["aria-label"],Fe={key:0,class:"preview-content"},Oe={key:0,class:"no-variables"},Be={key:1,class:"single-preview","data-testid":"single-preview"},Me=["innerHTML"],Ke={key:2,class:"cycling-preview","data-testid":"cycling-preview"},qe=["innerHTML"],He={class:"variable-legend"},Je=["data-testid"],Ge={class:"variable-value"},Ye=W(s({__name:"VariablePreviewCyclerV2",props:{template:{},variableBindings:{},variables:{},variableListRefs:{}},emits:["toggle-preview"],setup(a,{emit:s}){const m=a,g=s,{data:y,loading:h}=E(()=>$.variableLists.toArray(),{debounce:100}),k=t(!1),I=t(0);let V=null;const T=["variable-highlight-blue","variable-highlight-green","variable-highlight-purple","variable-highlight-orange","variable-highlight-pink","variable-highlight-teal"],L=e(()=>{let e=[];if(m.variableBindings?e=Object.keys(m.variableBindings):m.variables&&(e=Object.keys(m.variables)),m.variableListRefs){const a=Object.keys(m.variableListRefs);e=[...new Set([...e,...a])]}return P.debug("VariablePreviewCycler - Variable names",{names:e}),P.debug("VariablePreviewCycler - Variables",{variables:m.variables}),P.debug("VariablePreviewCycler - Variable list refs",{variableListRefs:m.variableListRefs}),e}),D=e(()=>{if(0===L.value.length)return[];if(!y.value||h.value)return[];const e=[];for(const t of L.value){let a=[];if(m.variableBindings){const e=m.variableBindings[t];if("direct"===e.type&&e.values)a=[...e.values];else if("list"===e.type&&e.listId){const t=y.value.find(a=>a.id===e.listId);t&&("simple"===t.category&&t.values?a=[...t.values]:"attributed"===t.category&&t.items&&(a=t.items.map(e=>e.value)))}}else if(m.variables&&m.variables[t]&&m.variables[t].length>0)a=[...m.variables[t]];else if(m.variableListRefs&&m.variableListRefs[t]){const e=m.variableListRefs[t];P.debug("Looking for list for variable",{listId:e,varName:t});const l=y.value.find(a=>a.id===e);P.debug("Found list",{list:l}),l?"simple"===l.category&&l.values?(a=[...l.values],P.debug("Using simple list values for variable",{varName:t,values:a})):"attributed"===l.category&&l.items&&(a=l.items.map(e=>e.value),P.debug("Using attributed list values for variable",{varName:t,values:a})):P.debug("No list found for variable",{varName:t,listId:e})}a.length>0&&e.push({name:t,values:a})}if(0===e.length)return[];const a=e.map(e=>e.values);return a.reduce((e,a)=>e.flatMap(e=>a.map(a=>[...e,a])),[[]]).map(a=>{const t={};return e.forEach((e,l)=>{t[e.name]=a[l]}),t})});function R(){k.value=!k.value,g("toggle-preview",k.value),k.value&&D.value.length>1?(S(),V=setInterval(()=>{I.value=(I.value+1)%D.value.length},1e3)):S()}function S(){V&&(clearInterval(V),V=null)}function N(e){return T[e%T.length]}function W(e){let a=m.template;return L.value.forEach((t,l)=>{if(void 0!==e[t]){const s=new RegExp(`\\{\\{\\s*${t}\\s*\\}\\}`,"g"),i=`<span class="${N(l)}">${z(String(e[t]))}</span>`;a=a.replace(s,i)}}),z(a).replace(/&lt;span class="([^"]*)"/g,'<span class="$1"').replace(/&lt;\/span&gt;/g,"</span>")}function z(e){const a=document.createElement("div");return a.textContent=e,a.innerHTML}return l(()=>m.template,()=>{I.value=0}),_(()=>{S()}),(e,a)=>{const t=w("a-button");return r(),i("div",je,[n("div",Ae,[u(t,{type:k.value?"default":"primary",ghost:!k.value,onClick:R,class:"toggle-button","data-testid":"btn-toggle-preview-mode","aria-label":k.value?"Return to editor mode":"Preview filled-in prompts","aria-pressed":k.value},{default:p(()=>[k.value?(r(),b(x(A),{key:1})):(r(),b(x(j),{key:0})),f(" "+d(k.value?"Return to Editor Mode":"Preview Filled-In Prompts"),1)]),_:1},8,["type","ghost","aria-label","aria-pressed"]),k.value&&D.value.length>1?(r(),i("div",Ue,[n("span",{class:"cycle-counter","data-testid":"cycle-counter","aria-label":`Showing combination ${I.value+1} of ${D.value.length}`},d(I.value+1)+" / "+d(D.value.length),9,ze),a[0]||(a[0]=n("span",{class:"cycle-hint"},"Auto-cycling every second",-1))])):o("",!0)]),k.value?(r(),i("div",Fe,[0===D.value.length?(r(),i("div",Oe,[u(x(U)),a[1]||(a[1]=n("span",null,"No variables detected in template",-1))])):1===D.value.length?(r(),i("div",Be,[n("div",{class:"preview-template",innerHTML:W(D.value[0]),"data-testid":"preview-template",role:"region","aria-label":"Preview of filled-in prompt"},null,8,Me)])):(r(),i("div",Ke,[n("div",{class:"preview-template",innerHTML:W(D.value[I.value]),"data-testid":"preview-template-cycling",role:"region","aria-label":"Preview of filled-in prompt with cycling variables"},null,8,qe),n("div",He,[(r(!0),i(c,null,v(L.value,(e,a)=>(r(),i("div",{key:e,class:"legend-item","data-testid":`legend-item-${e}`},[n("span",{class:C(N(a))},d(e),3),n("span",Ge,d(D.value[I.value][e]),1)],8,Je))),128))])]))])):o("",!0)])}}}),[["__scopeId","data-v-a59a5a89"]]),Xe={class:"list-selector"},Ze={key:0,class:"loading-container"},Qe={key:0,class:"list-grid"},ea=["onClick"],aa={class:"list-header"},ta={class:"item-count"},la={key:0,class:"list-description"},sa={class:"list-preview"},ia={key:0,class:"preview-more"},ra={key:1,class:"attributed-badge"},na={key:1,class:"empty-state"},oa=W(s({__name:"ListSelectorV2",props:{modelValue:{type:Boolean},listType:{}},emits:["update:modelValue","select"],setup(a,{emit:t}){const l=a,s=t,{data:m,loading:g,error:y}=E(()=>$.variableLists.toArray(),{debounce:100}),h=e(()=>{if(!m.value)return[];let e=[];return"all"===l.listType?e=m.value.filter(e=>"tabular"!==e.category):"simple"===l.listType?e=m.value.filter(e=>"simple"===e.category):"refusal"===l.listType&&(e=m.value.filter(e=>"refusal"===e.category)),e}),k=e=>"attributed"===e.category&&e.items?e.items.slice(0,5).map(e=>e.value):e.values?.slice(0,5)??[];return(e,a)=>{const t=w("a-spin"),l=w("a-alert");return r(),b(X,{"model-value":e.modelValue,title:"Select List",size:"medium","onUpdate:modelValue":a[1]||(a[1]=a=>e.$emit("update:modelValue",a))},{footer:p(()=>[u(R,{variant:"ghost",onClick:a[0]||(a[0]=a=>e.$emit("update:modelValue",!1))},{default:p(()=>a[2]||(a[2]=[f(" Cancel ")])),_:1,__:[2]})]),default:p(()=>[n("div",Xe,[x(g)?(r(),i("div",Ze,[u(t,{size:"large",tip:"Loading lists..."})])):x(y)?(r(),b(l,{key:1,type:"error",message:x(y).message||"Failed to load lists",class:"error-alert"},null,8,["message"])):(r(),i(c,{key:2},[h.value.length>0?(r(),i("div",Qe,[(r(!0),i(c,null,v(h.value,e=>(r(),i("div",{key:e.id,class:"list-option",onClick:a=>(e=>{s("select",e),s("update:modelValue",!1)})(e)},[n("div",aa,[n("h4",null,d(e.name),1),n("span",ta,d(e.itemCount)+" items",1)]),e.description?(r(),i("p",la,d(e.description),1)):o("",!0),n("div",sa,[(r(!0),i(c,null,v(k(e),(a,t)=>(r(),i("span",{key:`${e.id}-preview-${t}-${a}`,class:"preview-value"},d(a),1))),128)),e.itemCount>5?(r(),i("span",ia," +"+d(e.itemCount-5)+" more ",1)):o("",!0)]),"attributed"===e.category?(r(),i("div",ra," Attributed List ")):o("",!0)],8,ea))),128))])):(r(),i("div",na," No "+d(e.listType)+" lists available ",1))],64))])]),_:1},8,["model-value"])}}}),[["__scopeId","data-v-37085083"]]),ua={class:"summary-item carbon"},da={class:"summary-value"},ca={class:"summary-item water"},va={class:"summary-value"},ma={class:"summary-item energy"},pa={class:"summary-value"},fa={key:0,class:"summary-total"},ga={class:"total-label"},ba={class:"total-confidence"},ya=W(s({__name:"EnvironmentalCostSummary",props:{model:{},design:{},layout:{default:"compact"},showTotal:{type:Boolean,default:!1},totalCalls:{},totalTokens:{}},setup(a){const l=a,s=z(),u=e(()=>s.environmentalCostsEnabled),{calculateEnvironmentalCost:c,calculateEnvironmentalCostForDesign:v}=Q(),m=t({carbon:0,water:0,energy:0,confidence:"none",source:"no-data"});I(async()=>{if(u.value)if(l.totalTokens)try{m.value=await c(l.model.provider,l.model.modelId,l.totalTokens)}catch{m.value={carbon:0,water:0,energy:0,confidence:"none",source:"no-data"}}else if(l.design)try{m.value=await v(l.design,l.model,{})}catch{m.value={carbon:0,water:0,energy:0,confidence:"none",source:"no-data"}}else m.value={carbon:0,water:0,energy:0,confidence:"none",source:"no-data"};else m.value={carbon:0,water:0,energy:0,confidence:"none",source:"no-data"}});const p=e(()=>!0);function f(e,a){if(!u.value)return"??";if(0===e)return"—";switch(a){case"carbon":return e<.001?"<1mg":e<1?`${(1e3*e).toFixed(0)}mg`:`${e.toFixed(1)}g`;case"water":return e<.1?"<0.1mL":`${e.toFixed(1)}mL`;case"energy":return e<.001?"<1mWh":e<1?`${(1e3*e).toFixed(0)}mWh`:`${e.toFixed(1)}Wh`;default:return e.toString()}}return(e,a)=>p.value?(r(),i("div",{key:0,class:C(["environmental-summary",[`layout-${e.layout}`]])},[n("div",ua,[a[0]||(a[0]=n("span",{class:"summary-icon summary-icon-text"},"CO₂",-1)),n("span",da,d(f(m.value.carbon,"carbon")),1),a[1]||(a[1]=n("span",{class:"summary-unit"},"e",-1))]),n("div",ca,[a[2]||(a[2]=n("span",{class:"summary-icon"},"💧",-1)),n("span",va,d(f(m.value.water,"water")),1),a[3]||(a[3]=n("span",{class:"summary-unit"},"H₂O",-1))]),n("div",ma,[a[4]||(a[4]=n("span",{class:"summary-icon"},"⚡",-1)),n("span",pa,d(f(m.value.energy,"energy")),1),a[5]||(a[5]=n("span",{class:"summary-unit"},"Wh",-1))]),e.showTotal&&e.totalCalls?(r(),i("div",fa,[n("div",ga,d(e.totalCalls)+" calls",1),n("div",ba,d(m.value.confidence),1)])):o("",!0)],2)):o("",!0)}}),[["__scopeId","data-v-d5746b28"]]),ha={class:"model-selection-table"},ka={class:"table-header"},_a={class:"provider-header"},wa={class:"provider-name"},xa={class:"provider-count"},Ca={class:"provider-models"},Ia={class:"model-info"},Va={class:"model-name"},Ta={class:"model-cost"},La={key:0,class:"cost-primary"},Da=W(s({__name:"ModelSelectionTable",props:{models:{},totalCalls:{},design:{},modelParams:{}},setup(a){const l=a,s=t([]),m=t(!1),{data:f}=E(async()=>{const e=await $.settings.get("main");return e?[e]:[]},{debounce:100}),g=e(()=>f.value?.[0]?.financialCostsEnabled??!0),y=e(()=>{const e=l.models,a={};for(const t of e)a[t.provider]||(a[t.provider]=[]),a[t.provider].push(t);for(const t in a)a[t].sort((e,a)=>e.displayName.localeCompare(a.displayName));return a});function h(e){if(!e.capabilities)return 0;const a=l.design.tokenEstimate?.avgTokens||150,t=l.modelParams?.max_tokens||l.modelParams?.max_completion_tokens||256;return((e.capabilities.inputCostPerToken||0)*a+(e.capabilities.outputCostPerToken||0)*t)*l.totalCalls}return(e,a)=>{const t=w("a-collapse-panel"),l=w("a-collapse");return r(),i("div",ha,[n("div",ka,[n("h4",null,"Cost Estimation for "+d(e.totalCalls)+" API calls",1)]),u(l,{activeKey:s.value,"onUpdate:activeKey":a[0]||(a[0]=e=>s.value=e),ghost:""},{default:p(()=>[(r(!0),i(c,null,v(y.value,(a,l)=>(r(),b(t,{key:l},{header:p(()=>[n("div",_a,[n("span",wa,d(l),1),n("span",xa,"("+d(a.length)+" models)",1)])]),default:p(()=>[n("div",Ca,[(r(!0),i(c,null,v(a,a=>(r(),i("div",{key:`${a.provider}:${a.modelId}`,class:"model-row"},[n("div",Ia,[n("div",Va,d(a.displayName),1)]),n("div",Ta,[g.value?(r(),i("div",La,d(x(Z)(h(a))),1)):o("",!0),m.value?(r(),b(ya,{key:1,model:a,design:e.design,layout:"compact",class:"environmental-costs-inline"},null,8,["model","design"])):o("",!0)])]))),128))])]),_:2},1024))),128))]),_:1},8,["activeKey"])])}}}),[["__scopeId","data-v-c9680ef4"]]),Ra={class:"design-form-container"},Sa={key:0,class:"loading-container"},Ea={class:"name-desc-row"},Pa={key:0,class:"variable-hint"},$a={key:0,class:"variables-container"},Na={class:"variable-label"},Wa={class:"variable-content"},ja={class:"output-row"},Aa={class:"refusal-row"},Ua={class:"refusal-content"},za={class:"modal-footer"},Fa={class:"stats"},Oa={class:"actions"},Ba={class:"pricing-content"},Ma={key:0,class:"token-stats"},Ka={class:"stats-grid"},qa=W(s({__name:"DesignEditorV2",props:{modelValue:{type:Boolean},designId:{}},emits:["update:modelValue","saved"],setup(s,{emit:g}){const y=s,h=g;P.info("🎨 DesignEditorV2 component created",{modelValue:y.modelValue,designId:y.designId,hasDesignId:!!y.designId});const k=function(s){const i=e(()=>s());P.info("🚀 useDesignEditorV2 initialized",{initialDesignId:i.value,hasDesignId:!!i.value});const{data:r,loading:n}=Y(async()=>{const e=i.value;if(P.info("🔍 useLiveDataSingle query executing",{currentId:e,hasDesignId:!!e}),!e)return null;try{const a=await $.templatePrompts.get(e);return P.info("🔍 Template query result",{found:!!a,templateId:a?.id,templateName:a?.name,templateType:a?.type}),a}catch(a){return P.error("Failed to load template",a,{currentId:e}),null}},{debounce:0}),{data:o}=E(()=>$.variableLists.toArray(),{debounce:100}),u=a({name:"",description:"",promptTemplate:"",outputType:"text",extractPattern:"",refusalWords:[],refusalWordsListRef:"",refusalWordsSource:null,rejectRefusalWords:!1}),d=t({}),c=t({}),v=t({}),m=t(!1),p=t([]),f=t(!1),g=e(()=>ne.extractVariables(u.promptTemplate)),b=e(()=>ne.validateTemplate(u.promptTemplate)),y=e(()=>{const e=[];u.name.trim()||e.push("Name is required"),u.promptTemplate.trim()||e.push("Template is required"),b.value.isValid||e.push(...b.value.errors);const a=g.value.filter(e=>{const a=(d.value[e]?.length??0)>0,t=!!c.value[e];return!a&&!t});return a.length&&e.push(`Missing values for variables: ${a.join(", ")}`),{isValid:0===e.length,errors:e}}),h=e(()=>{const e={};for(const a of g.value)if(c.value[a]&&o.value){const t=o.value.find(e=>e.id===c.value[a]);e[a]=t?.itemCount??0}else e[a]=d.value[a]?.length??0;return e}),k=e(()=>J.getPermutationInfo(h.value));l(()=>u.promptTemplate,()=>{const e=g.value;for(const a in d.value)e.includes(a)||(delete d.value[a],delete c.value[a],delete v.value[a]);for(const a of e)a in d.value||a in c.value||(d.value[a]=[])}),l(y,e=>{p.value=e.errors}),l(r,e=>{P.info("🔍 editingTemplate watch triggered",{hasTemplate:!!e,templateId:e?.id,templateName:e?.name,designIdValue:i.value}),e&&w(e)},{immediate:!0});const _=i.value;function w(e){if(P.info("Loading template into form",{id:e.id,name:e.name,source:e.source}),f.value=!0,u.name=e.name,u.description=e.description||"",u.promptTemplate=e.template,u.outputType=e.outputConfig.outputType,u.extractPattern="string"==typeof e.outputConfig.extractPattern?e.outputConfig.extractPattern:"",u.rejectRefusalWords=e.outputConfig.rejectRefusalWords??!1,P.info("Form populated with template data",{formName:u.name,formDescription:u.description,formPromptTemplate:u.promptTemplate.substring(0,50)+"...",formOutputType:u.outputType}),u.refusalWords=e.outputConfig.refusalWords||[],u.refusalWordsListRef=e.outputConfig.refusalWordsListRef||"",u.refusalWordsSource=null,e.variables){d.value={},c.value={},v.value={};for(const[a,t]of Object.entries(e.variables))"list"===t.type&&t.listId?c.value[a]=t.listId:"direct"===t.type&&t.values&&(d.value[a]=[...t.values],t.source&&(v.value[a]=t.source))}}return P.info("🔍 Checking initial designId",{initialDesignId:_,hasInitialDesignId:!!_,typeOfDesignId:typeof _}),_?(P.info("🚀 Loading template immediately",{initialDesignId:_}),$.templatePrompts.get(_).then(e=>{P.info("📦 Direct query result",{found:!!e,templateId:e?.id,templateName:e?.name,templateType:e?.type}),e?(P.info("✅ Template loaded directly",{templateId:e.id,templateName:e.name}),w(e)):P.warn("❌ No template found for ID",{initialDesignId:_})}).catch(e=>{P.error("Failed to load template directly",e,{initialDesignId:_})})):P.info("⏭️ No initial designId, skipping immediate load"),l(i,e=>{P.info("🔄 designId changed in composable",{newId:e,hasNewId:!!e}),e&&e!==_&&$.templatePrompts.get(e).then(e=>{e&&(P.info("✅ Template loaded on designId change",{templateId:e.id,templateName:e.name}),w(e))}).catch(a=>{P.error("Failed to load template on change",a,{newId:e})})}),{form:u,variableArrays:d,variableListRefs:c,variableListSources:v,detectedVariables:g,templateValidation:b,validation:y,errors:p,variableCounts:h,permutationInfo:k,isSaving:m,isLoading:n,saveDesign:async function(e){if(y.value.isValid){m.value=!0;try{const e={};for(const s of g.value)if(c.value[s]&&o.value){const a=o.value.find(e=>e.id===c.value[s]);e[s]={type:"list",listId:c.value[s],listName:a?.name}}else d.value[s]?.length>0&&(e[s]={type:"direct",values:[...d.value[s]],source:v.value[s]&&null!==v.value[s]?{listId:v.value[s].listId,listName:v.value[s].listName}:void 0});const a={name:u.name,description:u.description||void 0,template:u.promptTemplate,variables:JSON.parse(JSON.stringify(e)),outputConfig:{outputType:u.outputType,extractPattern:u.extractPattern||void 0,refusalWords:u.refusalWords.length>0?[...u.refusalWords]:void 0,refusalWordsListRef:u.refusalWordsListRef||void 0,rejectRefusalWords:u.rejectRefusalWords},source:"manual"},t="default-data-v2"===r.value?.source,l=i.value;if(l&&!t)return P.info("Updating existing manual template",{designId:l}),await $.templatePrompts.update(l,{...a,updated:new Date}),l;{P.info("Creating new template",{reason:t?"editing default template":"new template",originalId:l});const e={...a,id:N(),type:"template",created:new Date,updated:new Date};return await $.templatePrompts.add(e),e.id}}finally{m.value=!1}}},loadDesign:async function(e){const a=e||i.value;P.info("🔍 useDesignEditor.loadDesign called",{providedId:e,constructorId:i.value,actualId:a,hasActualId:!!a}),a?P.debug("Template will be loaded via reactive subscription"):P.debug("No designId provided, skipping load")}}}(()=>y.designId);P.info("🎨 Editor initialized",{isLoadingValue:k.isLoading?.value,formName:k.form.name,designId:y.designId}),l(()=>y.modelValue,e=>{P.info("🎨 DesignEditorV2 visibility changed",{visible:e,designId:y.designId,hasDesignId:!!y.designId})});const{data:_}=E(()=>$.variableLists.toArray(),{debounce:100}),{data:C}=E(()=>$.models.where("enabled").equals(1).toArray(),{debounce:100}),I=e(()=>C.value||[]),T=e(()=>k.isLoading?.value??!1),L=t(!1),D=t(!1),R=t("all"),S=t(""),W=t(!1),j=t(null),A=t(null),z=[{bg:"#E8D5F2",text:"#6B21A8"},{bg:"#D5F2E8",text:"#047857"},{bg:"#FFE4D6",text:"#C2410C"},{bg:"#D6E4FF",text:"#1E40AF"},{bg:"#F3E8D5",text:"#92400E"}];function O(e){const a=k.detectedVariables.value.indexOf(e);return z[a%z.length]}function B(e){return`{{${e}}}`}function M(e){P.debug("Preview mode toggled",{isPreviewMode:e})}const K=e(()=>{const e={};return k.detectedVariables.value.forEach((a,t)=>{e[a]=z[t%z.length]}),e});function q(e){const a=k.variableListRefs.value[e];if(!a||!_.value)return;const t=_.value.find(e=>e.id===a);return t?.name}function H(e){const a=k.variableListRefs.value[e];if(!a||!_.value)return;const t=_.value.find(e=>e.id===a);return t?.itemCount}function Z(e){const a=k.variableListRefs.value[e];if(!a||!_.value)return;const t=_.value.find(e=>e.id===a);return t&&"attributed"===t.category&&t.items?t.items.slice(0,10):void 0}function Q(e){const a=k.variableListRefs.value[e];if(!a||!_.value)return;const t=_.value.find(e=>e.id===a);if(!t||"attributed"!==t.category)return;const l=[];return t.attributeKeys&&l.push(...t.attributeKeys.map((e,a)=>({text:e,colorIndex:a%5}))),{parts:l,totalItems:t.itemCount||0}}function ae(e){const a=k.variableListRefs.value[e];if(!a||!_.value)return;const t=_.value.find(e=>e.id===a);return t?.attributeKeys}function te(e){const a=k.variableListRefs.value[e];if(!a||!_.value)return;const t=_.value.find(e=>e.id===a);return t&&"simple"===t.category?t.values?.slice(0,10):void 0}function le(e){S.value&&("simple"===e.category?(k.variableArrays.value[S.value]=e.values||[],k.variableListRefs.value[S.value]="",k.variableListSources.value[S.value]={listId:e.id,listName:e.name}):(k.variableListRefs.value[S.value]=e.id,k.variableArrays.value[S.value]=[],k.variableListSources.value[S.value]=null)),L.value=!1}function se(){if(!k.form.refusalWordsListRef||!_.value)return;const e=_.value.find(e=>e.id===k.form.refusalWordsListRef);return e?.name}function ie(e){k.form.refusalWordsListRef=e.id,k.form.refusalWords=[],k.form.refusalWordsSource=null,D.value=!1}function re(){k.form.extractPattern=j.value}l(()=>k.form.extractPattern,e=>{const a=F.find(a=>a.value===e);j.value=a?a.value:null});const oe=e(()=>{const e={};for(const a of k.detectedVariables.value)if(k.variableListRefs.value[a]){const t=_.value?.find(e=>e.id===k.variableListRefs.value[a]);e[a]={type:"list",listId:k.variableListRefs.value[a],listName:t?.name}}else k.variableArrays.value[a]?.length>0&&(e[a]={type:"direct",values:[...k.variableArrays.value[a]]});return{id:y.designId||"temp",name:k.form.name,description:k.form.description,promptTemplate:k.form.promptTemplate,variableBindings:e,tokenEstimate:A.value||void 0,outputType:k.form.outputType,extractPattern:k.form.extractPattern,refusalWords:k.form.refusalWords,refusalWordsListRef:k.form.refusalWordsListRef,rejectRefusalWords:k.form.rejectRefusalWords,created:new Date,updated:new Date}});async function ue(){const e=await k.saveDesign(A.value||void 0);e&&(h("saved",e),h("update:modelValue",!1))}return l(W,async e=>{e&&!A.value&&(A.value=await G.calculateDesignTokens(oe.value))}),V(async()=>{P.info("🎨🎨🎨 DesignEditorV2 MOUNTED!",{designId:y.designId,isLoading:k.isLoading,formName:k.form.name,formPromptTemplate:k.form.promptTemplate?.substring(0,50)});const e=F.find(e=>e.value===k.form.extractPattern);j.value=e?e.value:null}),(e,a)=>{const t=w("a-spin"),l=w("a-input"),s=w("a-form-item"),g=w("a-select-option"),y=w("a-select"),h=w("a-checkbox"),_=w("a-alert"),C=w("a-form"),V=w("a-button"),E=w("a-modal");return r(),i(c,null,[u(X,{"model-value":e.modelValue,title:e.designId?"Edit Design":"Create Design",size:"full","data-testid":"modal-design-editor","onUpdate:modelValue":a[13]||(a[13]=a=>e.$emit("update:modelValue",a))},{footer:p(()=>[n("div",za,[n("div",Fa,d(x(k).detectedVariables.value.length)+" variables • "+d(x(k).permutationInfo.value.formatted)+" combinations ",1),n("div",Oa,[u(V,{size:"large",onClick:a[11]||(a[11]=e=>W.value=!0),"data-testid":"btn-calculate-pricing","aria-label":"Calculate pricing for this design"},{default:p(()=>a[30]||(a[30]=[f(" Calculate Pricing ")])),_:1,__:[30]}),u(V,{size:"large",onClick:a[12]||(a[12]=a=>e.$emit("update:modelValue",!1)),"data-testid":"btn-cancel-design","aria-label":"Cancel and close design editor"},{default:p(()=>a[31]||(a[31]=[f(" Cancel ")])),_:1,__:[31]}),u(V,{size:"large",type:"primary",onClick:ue,"data-testid":"btn-save-design","aria-label":"Save design and close editor"},{default:p(()=>a[32]||(a[32]=[f(" Save ")])),_:1,__:[32]})])])]),default:p(()=>[n("div",Ra,[T.value?(r(),i("div",Sa,[u(t,{size:"large",tip:"Loading template..."})])):(r(),b(C,{key:1,model:x(k).form,layout:"vertical",onFinish:ue},{default:p(()=>[n("div",Ea,[a[18]||(a[18]=n("label",{class:"inline-field-label"},"Name",-1)),u(s,{name:"name",rules:[{required:!0,message:"Required"}],class:"name-field"},{default:p(()=>[u(l,{value:x(k).form.name,"onUpdate:value":a[0]||(a[0]=e=>x(k).form.name=e),placeholder:"Enter design name",size:"large","data-testid":"input-design-name","aria-label":"Design name"},null,8,["value"])]),_:1}),a[19]||(a[19]=n("label",{class:"inline-field-label"},"Description",-1)),u(s,{name:"description",class:"desc-field"},{default:p(()=>[u(l,{value:x(k).form.description,"onUpdate:value":a[1]||(a[1]=e=>x(k).form.description=e),placeholder:"Optional description",size:"large","data-testid":"input-design-description","aria-label":"Design description"},null,8,["value"])]),_:1})]),u(s,{label:"Template",name:"promptTemplate",rules:[{required:!0,message:"Required"}],class:"template-form-item"},{default:p(()=>[0===x(k).detectedVariables.value.length?(r(),i("div",Pa,[u(x(U)),a[20]||(a[20]=n("span",null,[f("Type a prompt and use double curly braces to add a variable with conditions to vary, like "),n("code",null,"{{name}}"),f(" or "),n("code",null,"{{system_prompt}}"),f(". Variable names cannot contain spaces or punctuation except underscores (_).")],-1))])):o("",!0),u(ee,{modelValue:x(k).form.promptTemplate,"onUpdate:modelValue":a[2]||(a[2]=e=>x(k).form.promptTemplate=e),placeholder:"Enter your prompt template... Use {{variable}} for variables",rows:10,variables:x(k).detectedVariables.value,"variable-colors":K.value,"data-testid":"template-editor","aria-label":"Prompt template editor"},null,8,["modelValue","variables","variable-colors"]),x(k).detectedVariables.value.length>0&&x(k).form.promptTemplate?(r(),b(Ye,{key:1,template:x(k).form.promptTemplate,variables:x(k).variableArrays.value,"variable-list-refs":x(k).variableListRefs.value,onTogglePreview:M},null,8,["template","variables","variable-list-refs"])):o("",!0)]),_:1}),x(k).detectedVariables.value.length>0?(r(),i("div",$a,[(r(!0),i(c,null,v(x(k).detectedVariables.value,e=>(r(),i("div",{key:e,class:"variable-row"},[n("div",Na,[a[21]||(a[21]=n("span",{class:"variable-text"},"Variable:",-1)),n("span",{style:m({backgroundColor:O(e).bg,color:O(e).text}),class:"variable-badge"},d(B(e)),5)]),n("div",Wa,[u(We,{values:x(k).variableArrays.value[e]||[],"list-ref":x(k).variableListRefs.value[e],"list-name":q(e),source:x(k).variableListSources.value[e]||null,placeholder:`Enter a value for {{${e}}} and hit enter`,"attributed-samples":Z(e),"attribute-breakdown":Q(e),"attribute-keys":ae(e),"preview-values":te(e),"total-count":H(e),"onUpdate:values":a=>function(e,a){k.variableArrays.value[e]=a}(e,a),onClearSource:a=>function(e){k.variableListSources.value[e]=null}(e),onClearList:a=>function(e){k.variableListRefs.value[e]="",k.variableArrays.value[e]=[]}(e),onSelectList:a=>function(e){S.value=e,R.value="all",L.value=!0}(e)},null,8,["values","list-ref","list-name","source","placeholder","attributed-samples","attribute-breakdown","attribute-keys","preview-values","total-count","onUpdate:values","onClearSource","onClearList","onSelectList"])])]))),128))])):o("",!0),n("div",ja,[a[25]||(a[25]=n("label",{class:"row-label"},"Output Format",-1)),u(y,{value:x(k).form.outputType,"onUpdate:value":a[3]||(a[3]=e=>x(k).form.outputType=e),size:"large",style:{width:"120px"},"data-testid":"select-output-format","aria-label":"Select output format type"},{default:p(()=>[u(g,{value:"text"},{default:p(()=>a[22]||(a[22]=[f("Text")])),_:1,__:[22]}),u(g,{value:"number"},{default:p(()=>a[23]||(a[23]=[f("Number")])),_:1,__:[23]}),u(g,{value:"boolean"},{default:p(()=>a[24]||(a[24]=[f("Boolean")])),_:1,__:[24]})]),_:1},8,["value"]),a[26]||(a[26]=n("label",{class:"inline-label"},"Parse Preset",-1)),u(y,{value:j.value,"onUpdate:value":a[4]||(a[4]=e=>j.value=e),size:"large",style:{flex:"1"},placeholder:"Custom regex",onChange:re,"data-testid":"select-parse-preset","aria-label":"Select parsing preset"},{default:p(()=>[(r(!0),i(c,null,v(x(F),e=>(r(),b(g,{key:e.value,value:e.value},{default:p(()=>[f(d(e.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"]),a[27]||(a[27]=n("label",{class:"inline-label"},"Regex Extract",-1)),u(l,{value:x(k).form.extractPattern,"onUpdate:value":a[5]||(a[5]=e=>x(k).form.extractPattern=e),placeholder:"Leave blank for full response",size:"large",style:{flex:"1"},"data-testid":"input-regex-extract","aria-label":"Regular expression extraction pattern"},null,8,["value"])]),n("div",Aa,[a[29]||(a[29]=n("label",{class:"row-label"},"Parse Refusals",-1)),n("div",Ua,[u(We,{values:x(k).form.refusalWords,"list-ref":x(k).form.refusalWordsListRef,"list-name":se(),source:x(k).form.refusalWordsSource||null,placeholder:"Enter a refusal word and hit enter (e.g., cannot, unable, refuse)","onUpdate:values":a[6]||(a[6]=e=>x(k).form.refusalWords=e),onClearSource:a[7]||(a[7]=e=>x(k).form.refusalWordsSource=null),onClearList:a[8]||(a[8]=e=>(k.form.refusalWordsListRef="",void(k.form.refusalWords=[]))),onSelectList:a[9]||(a[9]=e=>D.value=!0)},null,8,["values","list-ref","list-name","source"])]),u(h,{checked:x(k).form.rejectRefusalWords,"onUpdate:checked":a[10]||(a[10]=e=>x(k).form.rejectRefusalWords=e),class:"reject-checkbox","data-testid":"checkbox-reject-refusals","aria-label":"Reject responses containing refusal words"},{default:p(()=>a[28]||(a[28]=[f(" Reject on match ")])),_:1,__:[28]},8,["checked"])]),x(k).errors.value.length>0?(r(),b(_,{key:1,type:"error","show-icon":"",class:"error-alert"},{message:p(()=>[f(d(x(k).errors.value.join(", ")),1)]),_:1})):o("",!0)]),_:1},8,["model"]))])]),_:1},8,["model-value","title"]),u(oa,{modelValue:L.value,"onUpdate:modelValue":a[14]||(a[14]=e=>L.value=e),"list-type":R.value,onSelect:le},null,8,["modelValue","list-type"]),u(oa,{modelValue:D.value,"onUpdate:modelValue":a[15]||(a[15]=e=>D.value=e),"list-type":"refusal",onSelect:ie},null,8,["modelValue"]),u(E,{open:W.value,"onUpdate:open":a[17]||(a[17]=e=>W.value=e),title:"Cost Estimation",width:"90vw",style:{maxWidth:"1000px"}},{footer:p(()=>[u(V,{onClick:a[16]||(a[16]=e=>W.value=!1)},{default:p(()=>a[34]||(a[34]=[f("Close")])),_:1,__:[34]})]),default:p(()=>[n("div",Ba,[A.value?(r(),i("div",Ma,[a[33]||(a[33]=n("h4",null,"Token Analysis",-1)),n("div",Ka,[n("div",null,"Min: "+d(A.value.minTokens),1),n("div",null,"Max: "+d(A.value.maxTokens),1),n("div",null,"Avg: "+d(A.value.avgTokens),1),n("div",null,"Sample: "+d(A.value.sampleSize),1)])])):o("",!0),u(Da,{models:I.value,"total-calls":x(k).permutationInfo.value.total,design:oe.value,"model-params":{}},null,8,["models","total-calls","design"])])]),_:1},8,["open"])],64)}}}),[["__scopeId","data-v-3a03e8e6"]]),Ha={class:"import-defaults-content"},Ja={class:"section-header"},Ga={class:"item-content"},Ya={class:"item-header"},Xa={class:"item-description"},Za={class:"item-meta"},Qa={class:"section-header"},et={class:"item-content"},at={class:"item-header"},tt={class:"item-description"},lt={class:"item-meta"},st={class:"modal-footer"},it=W(s({__name:"ImportDefaultsModalV2",props:{modelValue:{type:Boolean}},emits:["update:modelValue","imported"],setup(a,{emit:s}){const m=a,g=s,{data:y,loading:h}=E(()=>$.templatePrompts.toArray(),{debounce:100}),{data:k,loading:_}=E(()=>$.variableLists.toArray(),{debounce:100}),x=e({get:()=>m.modelValue,set:e=>g("update:modelValue",e)}),C=t("designs"),I=e(()=>h.value||_.value),T=t(!1),L=e(()=>y.value?new Set(y.value.map(e=>e.name)):new Set),D=e(()=>k.value?new Set(k.value.map(e=>e.name)):new Set),R=t({}),S=t({}),N=t(!1),W=t(!1),j=e(()=>O),A=e(()=>B),U=e(()=>{const e=Object.values(R.value).some(e=>e),a=Object.values(S.value).some(e=>e);return e||a});function z(){R.value={},S.value={},O.forEach(e=>{R.value[e.name]=!1}),B.forEach(e=>{S.value[e.name]=!1})}function F(){O.forEach(e=>{L.value.has(e.name)||(R.value[e.name]=N.value)})}function q(){B.forEach(e=>{D.value.has(e.name)||(S.value[e.name]=W.value)})}async function H(){T.value=!0;try{const{DefaultDataV2Service:e}=await M(async()=>{const{DefaultDataV2Service:e}=await import("./index-COu0csOc.js").then(e=>e.ao);return{DefaultDataV2Service:e}},__vite__mapDeps([0,1,2,3]),import.meta.url),a=Object.entries(R.value).filter(([e,a])=>a).map(([e])=>e),t=Object.entries(S.value).filter(([e,a])=>a).map(([e])=>e),l=await e.importDefaults(a.length>0?a:null,t.length>0?t:null),s=[];l.templates>0&&s.push(`${l.templates} templates`),l.lists>0&&s.push(`${l.lists} variable lists`),s.length>0?K.success(`Successfully imported ${s.join(" and ")}`):K.info("No new items were imported (may already exist)"),g("imported"),J()}catch(e){P.error("Import failed",e),K.error("Failed to import selected items")}finally{T.value=!1}}function J(){x.value=!1}function G(e){switch(e){case"attributed":return"blue";case"refusal":return"red";default:return"green"}}return V(()=>{z()}),l(()=>m.modelValue,e=>{e&&z()}),(e,a)=>{const t=w("a-alert"),l=w("a-checkbox"),s=w("a-tag"),m=w("a-list-item"),g=w("a-list"),y=w("a-tab-pane"),h=w("a-tabs"),k=w("a-button"),_=w("a-modal");return r(),b(_,{open:x.value,"onUpdate:open":a[3]||(a[3]=e=>x.value=e),title:"Import Default Designs & Variables",width:"95vw",footer:null,onCancel:J,centered:!0,"body-style":{height:"90vh",overflow:"auto"},"data-testid":"modal-import-defaults"},{default:p(()=>[n("div",Ha,[u(t,{type:"info",message:"Import pre-configured designs and variable lists",description:"Select which default designs and variable lists you want to import. These are carefully crafted templates for common LLM bias testing scenarios.","show-icon":!0,style:{marginBottom:"var(--spacing-xl)"}}),u(h,{activeKey:C.value,"onUpdate:activeKey":a[2]||(a[2]=e=>C.value=e)},{default:p(()=>[u(y,{key:"designs",tab:"Designs"},{default:p(()=>[n("div",Ja,[a[5]||(a[5]=n("h4",null,"Available Designs",-1)),u(l,{checked:N.value,"onUpdate:checked":a[0]||(a[0]=e=>N.value=e),onChange:F,"data-testid":"checkbox-select-all-designs","aria-label":"Select all designs for import"},{default:p(()=>a[4]||(a[4]=[f(" Select All ")])),_:1,__:[4]},8,["checked"])]),u(g,{"data-source":j.value,loading:I.value,size:"small",class:"import-list"},{renderItem:p(({item:e})=>[u(m,null,{default:p(()=>[u(l,{checked:R.value[e.name],"onUpdate:checked":a=>R.value[e.name]=a,disabled:L.value.has(e.name)},{default:p(()=>[n("div",Ga,[n("div",Ya,[n("strong",null,d(e.name),1),L.value.has(e.name)?(r(),b(s,{key:0,size:"small",color:"orange"},{default:p(()=>a[6]||(a[6]=[f(" Already Exists ")])),_:1,__:[6]})):o("",!0)]),n("div",Xa,d(e.description),1),n("div",Za,[(r(!0),i(c,null,v(Object.keys(e.variableBindings),e=>(r(),b(s,{key:e,size:"small"},{default:p(()=>[f(d(e),1)]),_:2},1024))),128))])])]),_:2},1032,["checked","onUpdate:checked","disabled"])]),_:2},1024)]),_:1},8,["data-source","loading"])]),_:1}),u(y,{key:"variables",tab:"Variable Lists"},{default:p(()=>[n("div",Qa,[a[8]||(a[8]=n("h4",null,"Available Variable Lists",-1)),u(l,{checked:W.value,"onUpdate:checked":a[1]||(a[1]=e=>W.value=e),onChange:q,"data-testid":"checkbox-select-all-variables","aria-label":"Select all variable lists for import"},{default:p(()=>a[7]||(a[7]=[f(" Select All ")])),_:1,__:[7]},8,["checked"])]),u(g,{"data-source":A.value,loading:I.value,size:"small",class:"import-list"},{renderItem:p(({item:e})=>[u(m,null,{default:p(()=>[u(l,{checked:S.value[e.name],"onUpdate:checked":a=>S.value[e.name]=a,disabled:D.value.has(e.name)},{default:p(()=>[n("div",et,[n("div",at,[n("strong",null,d(e.name),1),u(s,{size:"small",color:G(e.category)},{default:p(()=>[f(d(e.category),1)]),_:2},1032,["color"]),D.value.has(e.name)?(r(),b(s,{key:0,size:"small",color:"orange"},{default:p(()=>a[9]||(a[9]=[f(" Already Exists ")])),_:1,__:[9]})):o("",!0)]),n("div",tt,d(e.description),1),n("div",lt,d(e.itemCount)+" items ",1)])]),_:2},1032,["checked","onUpdate:checked","disabled"])]),_:2},1024)]),_:1},8,["data-source","loading"])]),_:1})]),_:1},8,["activeKey"]),n("div",st,[u(k,{onClick:J,size:"large",class:"footer-button","data-testid":"btn-cancel-import-defaults","aria-label":"Cancel import"},{default:p(()=>a[10]||(a[10]=[f(" Cancel ")])),_:1,__:[10]}),u(k,{type:"primary",onClick:H,loading:T.value,disabled:!U.value,size:"large",class:"footer-button footer-button-primary","data-testid":"btn-confirm-import-defaults","aria-label":"Import selected designs and variables"},{default:p(()=>a[11]||(a[11]=[f(" Import Selected ")])),_:1,__:[11]},8,["loading","disabled"])])])]),_:1},8,["open"])}}}),[["__scopeId","data-v-d987b2f9"]]),rt={class:"templates-view","data-testid":"page-templates"},nt={class:"page-header"},ot={key:3,class:"scientific-table-container"},ut={class:"scientific-table-wrapper"},dt={key:0,class:"table-info-cell"},ct={class:"table-info-title"},vt={class:"table-info-subtitle"},mt={key:1,class:"variables-cell"},pt={key:0},ft={class:"variables-calculation"},gt={class:"variable-item"},bt={key:0,class:"multiply-symbol"},yt={class:"equals-result"},ht={key:1,class:"text-secondary"},kt={key:0,class:"token-info"},_t={class:"token-line"},wt={key:0,class:"token-line"},xt={key:1,class:"text-secondary"},Ct={key:3,class:"usage-cell"},It={key:4,class:"source-cell"},Vt={key:5,class:"date-cell"},Tt={key:6,class:"table-actions-grid"},Lt=W(s({__name:"TemplatesView",setup(a){const l=L(),s=T(),{getVisibleColumns:m,formatDateTime:g,createDesignColumns:y}=S(),{data:h,error:k,loading:_}=E(()=>$.templatePrompts.orderBy("updated").reverse().toArray(),{debounce:100}),{data:C}=E(()=>$.variableLists.toArray(),{debounce:100}),I=e(()=>h.value||[]),R=t(!1),W=t(),j=t(!1),A=m(y()),U=e(()=>({y:"calc(100vh - 180px)"})),z=e(()=>I.value?I.value.map(e=>({...e,usedInTrials:0,totalApiCalls:0})):[]);function F(e){P.info("🎯 TemplatesView.editTemplate called",{templateId:e,templateName:I.value.find(a=>a.id===e)?.name}),W.value=e,D(()=>{R.value=!0,P.debug("Edit template state set after nextTick",{editingTemplateId:W.value,showEditor:R.value})})}function O(){W.value=void 0,R.value=!1}function B(){j.value=!1}function M(e){if(!e.template||!e.variables)return[];const a=ne.extractVariables(e.template),t=[];for(const l of a){const a=e.variables[l];if(!a)continue;let s=0;if("list"===a.type&&a.listId){const e=C.value?.find(e=>e.id===a.listId);e&&("simple"===e.category?s=e.values?.length||0:"attributed"===e.category&&(s=e.items?.length||0))}else"direct"===a.type&&(s=a.values?.length||0);s>0&&t.push({name:`{{${l}}}`,count:s})}return t}function K(e){if(!e.variables)return 1;const a={};for(const[t,l]of Object.entries(e.variables)){const e=l;if("list"===e.type&&e.listId){const l=C.value?.find(a=>a.id===e.listId);l&&("simple"===l.category?a[t]=l.values?.length||0:"attributed"===l.category&&(a[t]=l.items?.length||0))}else"direct"===e.type&&(a[t]=e.values?.length||0)}return J.calculateTotalPermutations(a)}function G(e){return e>999999?`${(e/1e6).toFixed(1)}M`:e>9999?`${(e/1e3).toFixed(0)}k`:e.toLocaleString()}function Y(e){return"legacy-design"===e.migrationSource?"Migrated":"default-data-v2"===e.source?"Default":e.created&&new Date(e.created)>new Date("2025-01-01")?"Manual":"Unknown"}function X(e){switch(Y(e)){case"Default":return"blue";case"Migrated":return"orange";case"Manual":return"green";default:return"default"}}return V(()=>{"true"===s.query.create&&(R.value=!0,l.replace({name:"templates"}))}),(e,a)=>{const t=w("a-button"),s=w("a-space"),m=w("a-spin"),y=w("a-alert"),h=w("a-empty"),C=w("a-tag"),V=w("a-table");return r(),i("div",rt,[n("div",nt,[a[8]||(a[8]=n("div",{class:"header-content"},[n("h1",null,"Prompt Templates"),n("p",{class:"description"},"Create and manage prompt templates for systematic testing")],-1)),u(s,null,{default:p(()=>[u(t,{onClick:a[0]||(a[0]=e=>j.value=!0),"data-testid":"btn-import-defaults","aria-label":"Import default prompt templates"},{icon:p(()=>[u(x(q))]),default:p(()=>[a[6]||(a[6]=f(" Import Defaults "))]),_:1,__:[6]}),u(t,{type:"primary",onClick:a[1]||(a[1]=e=>R.value=!0),"data-testid":"btn-create-template","aria-label":"Create new template"},{icon:p(()=>[u(x(H))]),default:p(()=>[a[7]||(a[7]=f(" Create Template "))]),_:1,__:[7]})]),_:1})]),x(_)?(r(),b(m,{key:0,size:"large",tip:"Loading templates..."},{default:p(()=>a[9]||(a[9]=[n("div",{style:{"min-height":"200px"}},null,-1)])),_:1,__:[9]})):x(k)?(r(),b(y,{key:1,type:"error",message:x(k)?.message||"Failed to load templates",class:"error-alert"},null,8,["message"])):0===I.value.length?(r(),b(h,{key:2,description:"No templates yet. Create your first prompt template to start testing."},{image:p(()=>a[10]||(a[10]=[n("div",{class:"empty-state-icon"},"📝",-1)])),default:p(()=>[u(t,{type:"primary",onClick:a[2]||(a[2]=e=>R.value=!0),"data-testid":"btn-create-first-template","aria-label":"Create your first prompt template"},{default:p(()=>a[11]||(a[11]=[f(" Create Your First Template ")])),_:1,__:[11]})]),_:1})):(r(),i("div",ot,[n("div",ut,[u(V,{columns:x(A),"data-source":z.value,pagination:!1,size:"small",scroll:U.value,"row-key":"id",class:"scientific-table","data-testid":"table-templates",role:"table","aria-label":"Prompt templates table"},{bodyCell:p(({column:e,record:s})=>{return["name"===e.key?(r(),i("div",dt,[n("span",ct,d(s.name),1),n("span",vt,d(s.description||"No description"),1)])):o("",!0),"variables"===e.key?(r(),i("div",mt,[M(s).length>0?(r(),i("div",pt,[n("div",ft,[(r(!0),i(c,null,v(M(s),(e,a)=>(r(),i("span",{key:e.name},[n("span",gt,d(e.name)+" ("+d(e.count)+")",1),a<M(s).length-1?(r(),i("span",bt," × ")):o("",!0)]))),128)),n("span",yt," = "+d(G(K(s)))+" cases",1)])])):(r(),i("span",ht,"None"))])):o("",!0),"tokens"===e.key?(r(),i(c,{key:2},[s.tokenEstimate?(r(),i("div",kt,[n("div",_t," Per-prompt: ~"+d(s.tokenEstimate.avgTokens),1),K(s)>1?(r(),i("div",wt," × "+d(K(s))+" = ~"+d(G(K(s)*s.tokenEstimate.avgTokens)),1)):o("",!0)])):(r(),i("span",xt,"-"))],64)):o("",!0),"stats"===e.key?(r(),i("div",Ct,[n("div",null,d(s.usedInTrials||0)+" trials",1),n("div",null,d(s.totalApiCalls||0)+" calls",1)])):o("",!0),"source"===e.key?(r(),i("div",It,[u(C,{color:X(s),size:"small",class:"source-tag"},{default:p(()=>[f(d(Y(s)),1)]),_:2},1032,["color"])])):o("",!0),"created"===e.key?(r(),i("div",Vt,d((m=s.created,g(m))),1)):o("",!0),"actions"===e.key?(r(),i("div",Tt,[u(t,{size:"small",type:"primary",onClick:e=>F(s.id),"data-testid":"btn-edit-template","data-template-id":s.id,"aria-label":`Edit template ${s.name}`},{default:p(()=>a[12]||(a[12]=[f(" Edit ")])),_:2,__:[12]},1032,["onClick","data-template-id","aria-label"]),u(t,{size:"small",type:"primary",onClick:e=>{return a=s.id,void l.push({path:"/trials",query:{promptSource:"template",promptId:a}});var a},"data-testid":"btn-new-trial-from-template","data-template-id":s.id,"aria-label":`Create new trial from template ${s.name}`},{default:p(()=>a[13]||(a[13]=[f(" New Trial ")])),_:2,__:[13]},1032,["onClick","data-template-id","aria-label"]),u(t,{size:"small",onClick:e=>async function(e){try{const a=await $.templatePrompts.get(e);if(!a)throw new Error("Template not found");const t={...a,id:N(),name:`${a.name} (Copy)`,created:new Date,updated:new Date};await $.templatePrompts.add(t),F(t.id)}catch(a){P.error("Failed to duplicate template",a)}}(s.id),"data-testid":"btn-duplicate-template","data-template-id":s.id,"aria-label":`Duplicate template ${s.name}`},{default:p(()=>a[14]||(a[14]=[f(" Copy ")])),_:2,__:[14]},1032,["onClick","data-template-id","aria-label"]),u(t,{size:"small",danger:"",onClick:e=>async function(e){if(confirm("Are you sure you want to delete this template?"))try{await $.templatePrompts.delete(e)}catch(a){P.error("Failed to delete template",a),alert(a instanceof Error?a.message:"Failed to delete template")}}(s.id),"data-testid":"btn-delete-template","data-template-id":s.id,"aria-label":`Delete template ${s.name}`},{default:p(()=>a[15]||(a[15]=[f(" Delete ")])),_:2,__:[15]},1032,["onClick","data-template-id","aria-label"])])):o("",!0)];var m}),_:1},8,["columns","data-source","scroll"])])])),u(qa,{modelValue:R.value,"onUpdate:modelValue":[a[3]||(a[3]=e=>R.value=e),a[4]||(a[4]=e=>{e||(W.value=void 0)})],"design-id":W.value,onSaved:O},null,8,["modelValue","design-id"]),u(it,{modelValue:j.value,"onUpdate:modelValue":a[5]||(a[5]=e=>j.value=e),onImported:B},null,8,["modelValue"])])}}}),[["__scopeId","data-v-b39aeea8"]]);export{Lt as default};
