import{d as l,a as f,r as L,c as S}from"./index-CTja5tg7.js";import{b as E}from"./useV4VariableLists-TWUqAxNb.js";class j{async create(r){try{const e=crypto.randomUUID(),t=new Date,s=this.validateCreateData(r);if(!s.valid)return{ok:!1,error:new Error(`Validation failed: ${s.errors.join(", ")}`)};const a={id:e,name:r.name,description:r.description,category:r.category,itemCount:this.calculateItemCount(r),created:t,updated:t};this.applyCategoryData(a,r);const n=Object.freeze(a);return await l.transaction("rw",l.variableLists,async()=>{await l.variableLists.add(n)}),f.info("V4: Created variable list",{id:e,name:r.name,category:r.category}),E("variableLists","create"),{ok:!0,value:e}}catch(e){return f.error("V4: Failed to create variable list",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to create variable list")}}}async update(r,e){try{const t=await l.variableLists.get(r);if(!t)return{ok:!1,error:new Error("Variable list not found")};const s={...e,updated:new Date};if(this.hasContentChanges(e)){const a={...t,...e};s.itemCount=this.calculateItemCount(a)}return this.freezeUpdateData(s),await l.transaction("rw",l.variableLists,async()=>{await l.variableLists.update(r,s)}),f.info("V4: Updated variable list",{id:r,updates:Object.keys(e)}),E("variableLists","update"),{ok:!0,value:void 0}}catch(t){return f.error("V4: Failed to update variable list",t),{ok:!1,error:t instanceof Error?t:new Error("Failed to update variable list")}}}async delete(r){try{const e=await l.variableLists.get(r);if(!e)return{ok:!1,error:new Error("Variable list not found")};const t=await this.findTemplateReferences(r);return t.length>0?{ok:!1,error:new Error(`Cannot delete list: referenced by ${t.length} templates. Remove references first.`)}:(await l.transaction("rw",l.variableLists,async()=>{await l.variableLists.delete(r)}),f.info("V4: Deleted variable list",{id:r,name:e.name}),E("variableLists","delete"),{ok:!0,value:void 0})}catch(e){return f.error("V4: Failed to delete variable list",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to delete variable list")}}}async duplicate(r,e){try{const t=await l.variableLists.get(r);if(!t)return{ok:!1,error:new Error("Variable list not found")};const s={name:e||`${t.name} (Copy)`,description:t.description,category:t.category};return t.values&&(s.values=[...t.values]),t.items&&(s.items=t.items.map(a=>({value:a.value,attributes:{...a.attributes}}))),t.attributeKeys&&(s.attributeKeys=[...t.attributeKeys]),t.tabularData&&(s.tabularData={columns:[...t.tabularData.columns],rows:t.tabularData.rows.map(a=>({...a}))}),await this.create(s)}catch(t){return f.error("V4: Failed to duplicate variable list",t),{ok:!1,error:t instanceof Error?t:new Error("Failed to duplicate variable list")}}}async bulkCreate(r){try{const e=[],t=new Date;for(const a of r){const n=this.validateCreateData(a);if(!n.valid)return{ok:!1,error:new Error(`Bulk validation failed for "${a.name}": ${n.errors.join(", ")}`)}}const s=r.map(a=>{const n=crypto.randomUUID(),o={id:n,name:a.name,description:a.description,category:a.category,itemCount:this.calculateItemCount(a),created:t,updated:t};return this.applyCategoryData(o,a),e.push(n),Object.freeze(o)});return await l.transaction("rw",l.variableLists,async()=>{await l.variableLists.bulkAdd(s)}),f.info("V4: Bulk created variable lists",{count:r.length}),{ok:!0,value:e}}catch(e){return f.error("V4: Failed to bulk create variable lists",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to bulk create variable lists")}}}async bulkUpdate(r){try{const e=r.map(n=>n.id),t=await l.variableLists.where("id").anyOf(e).toArray();if(t.length!==e.length){const n=new Set(t.map(i=>i.id)),o=e.filter(i=>!n.has(i));return{ok:!1,error:new Error(`Some variable lists not found: ${o.join(", ")}`)}}const s=new Date,a=r.map(({id:n,data:o})=>{const i={...o,updated:s};return this.freezeUpdateData(i),{key:n,changes:i}});return await l.transaction("rw",l.variableLists,async()=>{await l.variableLists.bulkUpdate(a)}),f.info("V4: Bulk updated variable lists",{count:r.length}),{ok:!0,value:void 0}}catch(e){return f.error("V4: Failed to bulk update variable lists",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to bulk update variable lists")}}}async bulkDelete(r){try{return(await Promise.all(r.map(s=>this.findTemplateReferences(s)))).some(s=>s.length>0)?{ok:!1,error:new Error("Cannot bulk delete: some lists are referenced by templates")}:(await l.transaction("rw",l.variableLists,async()=>{await l.variableLists.bulkDelete(r)}),f.info("V4: Bulk deleted variable lists",{count:r.length}),{ok:!0,value:void 0})}catch(e){return f.error("V4: Failed to bulk delete variable lists",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to bulk delete variable lists")}}}async importFromCSV(r,e,t,s){try{const a=this.parseCSV(r);if(a.headers.length===0||a.rows.length===0)return{ok:!1,error:new Error("CSV file is empty or invalid")};let n;if(t==="attributed"){const o=a.headers.find(c=>c.toLowerCase()==="value"||c.toLowerCase()==="name");if(!o)return{ok:!1,error:new Error('CSV must have a "value" or "name" column for attributed lists')};const i=a.headers.filter(c=>c!==o),b=a.rows.map(c=>({value:c[o]||"",attributes:i.reduce((m,p)=>(m[p]=c[p]||"",m),{})})).filter(c=>c.value.trim()).map(c=>Object.freeze(c));n={name:e,description:s,category:t,items:b,attributeKeys:i}}else{const o=a.rows.map(i=>i[a.headers[0]]||"").filter(i=>i.trim());n={name:e,description:s,category:t,values:o}}return await this.create(n)}catch(a){return f.error("V4: Failed to import CSV",a),{ok:!1,error:a instanceof Error?a:new Error("Failed to import CSV")}}}async exportToCSV(r){try{const e=await l.variableLists.get(r);if(!e)return{ok:!1,error:new Error("Variable list not found")};let t;if(e.category==="simple"||e.category==="refusal"){if(!e.values)return{ok:!1,error:new Error("List has no values")};t=`value
${e.values.join(`
`)}`}else if(e.category==="attributed"){if(!e.items||!e.attributeKeys)return{ok:!1,error:new Error("Attributed list has no items or keys")};const a=[["value",...e.attributeKeys].join(",")];e.items.forEach(n=>{const o=[this.escapeCSVValue(n.value),...e.attributeKeys.map(i=>this.escapeCSVValue(n.attributes[i]||""))];a.push(o.join(","))}),t=a.join(`
`)}else if(e.category==="tabular"){if(!e.tabularData)return{ok:!1,error:new Error("Tabular list has no data")};const s=e.tabularData.columns,a=[s.join(",")];e.tabularData.rows.forEach(n=>{const o=s.map(i=>this.escapeCSVValue(String(n[i]||"")));a.push(o.join(","))}),t=a.join(`
`)}else return{ok:!1,error:new Error(`Export not supported for category: ${e.category}`)};return{ok:!0,value:t}}catch(e){return f.error("V4: Failed to export CSV",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to export CSV")}}}async exportToJSON(r){try{const e=await l.variableLists.get(r);return e?{ok:!0,value:JSON.stringify(e,null,2)}:{ok:!1,error:new Error("Variable list not found")}}catch(e){return f.error("V4: Failed to export JSON",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to export JSON")}}}async validateCrossReferences(){try{return{ok:!0,value:{totalLists:await l.variableLists.count(),invalidReferences:[],missingLists:[]}}}catch(r){return f.error("V4: Failed to validate cross references",r),{ok:!1,error:r instanceof Error?r:new Error("Failed to validate cross references")}}}async cleanupOrphanedReferences(){try{return{ok:!0,value:{removedReferences:0,affectedTemplates:[]}}}catch(r){return f.error("V4: Failed to cleanup orphaned references",r),{ok:!1,error:r instanceof Error?r:new Error("Failed to cleanup orphaned references")}}}validateCreateData(r){var t;const e=[];switch((t=r.name)!=null&&t.trim()||e.push("Name is required"),r.category||e.push("Category is required"),r.category){case"simple":case"refusal":(!r.values||r.values.length===0)&&e.push(`${r.category} lists require at least one value`);break;case"attributed":(!r.items||r.items.length===0)&&e.push("Attributed lists require at least one item"),(!r.attributeKeys||r.attributeKeys.length===0)&&e.push("Attributed lists require at least one attribute key");break;case"tabular":(!r.tabularData||!r.tabularData.columns||r.tabularData.columns.length===0)&&e.push("Tabular lists require at least one column"),(!r.tabularData||!r.tabularData.rows||r.tabularData.rows.length===0)&&e.push("Tabular lists require at least one row");break}return{valid:e.length===0,errors:e}}calculateItemCount(r){var e,t,s,a;switch(r.category){case"simple":case"refusal":return((e=r.values)==null?void 0:e.length)||0;case"attributed":return((t=r.items)==null?void 0:t.length)||0;case"tabular":return((a=(s=r.tabularData)==null?void 0:s.rows)==null?void 0:a.length)||0;default:return 0}}applyCategoryData(r,e){switch(e.category){case"simple":case"refusal":e.values&&(r.values=Object.freeze([...e.values]));break;case"attributed":e.items&&(r.items=Object.freeze(e.items.map(t=>Object.freeze({value:t.value,attributes:Object.freeze({...t.attributes})})))),e.attributeKeys&&(r.attributeKeys=Object.freeze([...e.attributeKeys]));break;case"tabular":e.tabularData&&(r.tabularData=Object.freeze({columns:Object.freeze([...e.tabularData.columns]),rows:Object.freeze(e.tabularData.rows.map(t=>Object.freeze({...t})))}));break}}hasContentChanges(r){return!!(r.values||r.items||r.attributeKeys||r.tabularData)}freezeUpdateData(r){r.values&&(r.values=Object.freeze([...r.values])),r.items&&(r.items=Object.freeze(r.items.map(e=>Object.freeze({value:e.value,attributes:Object.freeze({...e.attributes})})))),r.attributeKeys&&(r.attributeKeys=Object.freeze([...r.attributeKeys])),r.tabularData&&(r.tabularData=Object.freeze({columns:Object.freeze([...r.tabularData.columns]),rows:Object.freeze(r.tabularData.rows.map(e=>Object.freeze({...e})))}))}async findTemplateReferences(r){try{const e=await l.template_prompts.toArray(),t=[];for(const s of e)if(s.variables){for(const a of Object.values(s.variables))if(a.type==="list"&&a.listId===r){t.push(s.id);break}}return t}catch(e){return f.error("V4: Failed to find template references",e),[]}}parseCSV(r){const e=r.split(`
`).map(a=>a.trim()).filter(Boolean);if(e.length===0)return{headers:[],rows:[]};const t=this.parseCSVLine(e[0]);if(t.length===0)return{headers:[],rows:[]};const s=[];for(let a=1;a<e.length;a++){const n=this.parseCSVLine(e[a]);if(n.every(i=>!i.trim()))continue;const o={};t.forEach((i,b)=>{o[i]=n[b]||""}),s.push(o)}return{headers:t,rows:s}}parseCSVLine(r){const e=[];let t="",s=!1,a=0;for(;a<r.length;){const n=r[a];n==='"'?s&&r[a+1]==='"'?(t+='"',a+=2):(s=!s,a++):n===","&&!s?(e.push(t.trim()),t="",a++):(t+=n,a++)}return e.push(t.trim()),e}escapeCSVValue(r){return r?r.includes(",")||r.includes('"')||r.includes(`
`)?`"${r.replace(/"/g,'""')}"`:r:""}}const d=new j;function F(){const y=L(new Set),r=L(null),e=S(()=>y.value.size>0);function t(){r.value=null}async function s(u,w){y.value.add(u),r.value=null;try{const h=await w();return h.ok||(r.value=h.error),h}catch(h){const V=h instanceof Error?h:new Error("Command execution failed");return r.value=V,{ok:!1,error:V}}finally{y.value.delete(u)}}async function a(u){return s("create",()=>d.create(u))}async function n(u,w){return s("update",()=>d.update(u,w))}async function o(u){return s("delete",()=>d.delete(u))}async function i(u,w){return s("duplicate",()=>d.duplicate(u,w))}async function b(u){return s("bulkCreate",()=>d.bulkCreate(u))}async function c(u){return s("bulkUpdate",()=>d.bulkUpdate(u))}async function m(u){return s("bulkDelete",()=>d.bulkDelete(u))}async function p(u,w,h,V){return s("importCSV",()=>d.importFromCSV(u,w,h,V))}async function v(u){return s("exportCSV",()=>d.exportToCSV(u))}async function k(u){return s("exportJSON",()=>d.exportToJSON(u))}async function g(){return s("validate",()=>d.validateCrossReferences())}async function C(){return s("cleanup",()=>d.cleanupOrphanedReferences())}return{createVariableList:a,updateVariableList:n,deleteVariableList:o,duplicateVariableList:i,bulkCreateVariableLists:b,bulkUpdateVariableLists:c,bulkDeleteVariableLists:m,importFromCSV:p,exportToCSV:v,exportToJSON:k,validateCrossReferences:g,cleanupOrphanedReferences:C,isExecuting:e,lastError:r,clearError:t}}function z(){const y=L(null);function r(s,a){const n=[];let o=null;try{const b=s.split(`
`).map(p=>p.trim()).filter(Boolean);if(b.length===0)return n.push("CSV file is empty"),{valid:!1,errors:n,preview:o};const c=t(b[0]);if(c.length===0)return n.push("CSV headers are empty"),{valid:!1,errors:n,preview:o};const m=[];for(let p=1;p<Math.min(b.length,6);p++){const v=t(b[p]);if(v.every(g=>!g.trim()))continue;const k={};c.forEach((g,C)=>{k[g]=v[C]||""}),m.push(k)}if(a==="attributed"){const p=c.find(v=>v.toLowerCase()==="value"||v.toLowerCase()==="name");p?c.filter(k=>k!==p).length===0&&n.push("Attributed lists require at least one attribute column"):n.push('Attributed lists require a "value" or "name" column')}o={headers:c,rows:m,totalRows:b.length-1,validRows:m.length}}catch(b){n.push(`CSV parsing error: ${b instanceof Error?b.message:"Unknown error"}`)}const i={valid:n.length===0,errors:n,preview:o};return y.value=i,i}async function e(s,a,n,o){const i=r(s,n);return i.valid?d.importFromCSV(s,a,n,o):{ok:!1,error:new Error(`Validation failed: ${i.errors.join(", ")}`)}}function t(s){const a=[];let n="",o=!1,i=0;for(;i<s.length;){const b=s[i];b==='"'?o&&s[i+1]==='"'?(n+='"',i+=2):(o=!o,i++):b===","&&!o?(a.push(n.trim()),n="",i++):(n+=b,i++)}return a.push(n.trim()),a}return{validateCSV:r,importWithValidation:e,lastValidation:y}}export{z as a,F as u};
